<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zambia Emergency Response - Emergency Reporting System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --secondary: #2563eb;
            --accent: #059669;
            --dark: #1f2937;
            --light: #f3f4f6;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(to bottom, #1e40af 0%, #dc2626 100%);
            min-height: 100vh;
        }

        .emergency-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .emergency-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .emergency-btn {
            background: white;
            border-radius: 12px;
            padding: 1.2rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 140px;
        }

        .emergency-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        #map {
            height: 300px;
            width: 100%;
            border-radius: 12px;
            z-index: 1;
        }

        #emergency-map {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            z-index: 1;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 1rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transform: translateX(calc(100% + 20px));
            transition: transform 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .calling-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        .phone-ring {
            animation: ring 1.5s infinite;
            transform-origin: center;
        }

        @keyframes ring {

            0%,
            100% {
                transform: rotate(0);
            }

            25% {
                transform: rotate(15deg);
            }

            50% {
                transform: rotate(-15deg);
            }

            75% {
                transform: rotate(5deg);
            }
        }

        .priority-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            background: linear-gradient(to right, #3b82f6, #10b981);
        }

        .step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            background: #e5e7eb;
            color: #6b7280;
        }

        .step-indicator.active {
            background: #3b82f6;
            color: white;
        }

        .step-indicator.completed {
            background: #10b981;
            color: white;
        }

        .responder-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .responder-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .rescue-center-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border-left: 4px solid #dc2626;
        }

        .rescue-center-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .login-tab {
            padding: 1rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .login-tab.active {
            background: #dc2626;
            color: white;
        }

        .floating-action {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 100;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .user-type-btn {
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }

        .user-type-btn:hover {
            border-color: #3b82f6;
            transform: translateY(-3px);
        }

        .user-type-btn.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .hidden {
            display: none;
        }

        .responder-view {
            display: none;
        }

        .emergency-item {
            border-left: 4px solid #dc2626;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .emergency-item:hover {
            transform: translateX(5px);
        }

        .emergency-item.critical {
            border-left-color: #dc2626;
        }

        .emergency-item.serious {
            border-left-color: #f59e0b;
        }

        .emergency-item.moderate {
            border-left-color: #3b82f6;
        }

        .recommended-center {
            border: 2px solid #10b981;
            background-color: #f0fdf4;
        }

        .recommended-badge {
            background-color: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* Emergency type radio buttons */
        .emergency-type-radio {
            display: none;
        }

        .emergency-type-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }

        .emergency-type-radio:checked+.emergency-type-label {
            border-color: #dc2626;
            background-color: #fef2f2;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .emergency-type-label:hover {
            border-color: #dc2626;
        }

        .emergency-type-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        /* Required field indicator */
        .required-field::after {
            content: "*";
            color: #dc2626;
            margin-left: 3px;
        }

        /* Form sections */
        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        /* Image preview styles */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .image-preview {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        /* Emergency image in responder view */
        .emergency-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            max-height: 200px;
            object-fit: cover;
        }

        /* Map modal */
        .map-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .map-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            height: 80%;
            padding: 20px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f3f4f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        /* Dispatch modal */
        .dispatch-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .dispatch-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            padding: 20px;
            position: relative;
        }

        /* Alert Notification Styles */
        .alert-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            width: 400px;
            max-width: 90vw;
            background: linear-gradient(135deg, #ff4d4d 0%, #cc0000 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateX(calc(100% + 20px));
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-left: 6px solid #ffcc00;
            overflow: hidden;
        }

        .alert-notification.show {
            transform: translateX(0);
        }

        .alert-notification.pulse {
            animation: alertPulse 2s infinite;
        }

        @keyframes alertPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(255, 77, 77, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 77, 77, 0);
            }
        }

        .alert-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .alert-title {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
        }

        .alert-icon {
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .alert-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .alert-close:hover {
            opacity: 1;
        }

        .alert-content {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .alert-details {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .alert-detail-row {
            display: flex;
            margin-bottom: 5px;
        }

        .alert-detail-label {
            font-weight: 600;
            width: 120px;
            flex-shrink: 0;
        }

        .alert-actions {
            display: flex;
            gap: 10px;
        }

        .alert-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .alert-btn-primary {
            background: #ffcc00;
            color: #333;
        }

        .alert-btn-primary:hover {
            background: #ffdb4d;
        }

        .alert-btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .alert-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .alert-sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: #3b82f6;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .alert-sound-toggle.muted {
            background: #6b7280;
        }

        .alert-sound-toggle:hover {
            transform: scale(1.1);
        }

        .alert-counter {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Real-time connection status styles */
        .online-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #10b981;
            margin-right: 5px;
        }

        .offline-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ef4444;
            margin-right: 5px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            color: #6b7280;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 50;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .real-time-badge {
            background-color: #3b82f6;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 5px;
        }

        .new-emergency-indicator {
            animation: newEmergencyPulse 2s infinite;
        }

        @keyframes newEmergencyPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* Responsive design improvements */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-status {
                margin-top: 0.5rem;
                align-self: flex-start;
            }

            .emergency-btn {
                min-height: 120px;
                padding: 1rem;
            }

            .step-indicator {
                width: 28px;
                height: 28px;
                font-size: 0.875rem;
            }

            .floating-action {
                bottom: 1.5rem;
                right: 1.5rem;
                width: 50px;
                height: 50px;
            }

            .user-type-btn {
                padding: 1rem;
            }

            .rescue-center-card {
                flex-direction: column;
            }

            .rescue-center-card .text-right {
                text-align: left;
                margin-top: 1rem;
            }

            .emergency-type-label {
                padding: 1rem;
            }

            .emergency-type-icon {
                font-size: 2rem;
            }

            .map-modal-content {
                height: 70%;
                width: 95%;
            }

            .alert-notification {
                width: 90vw;
                right: 5vw;
            }

            .connection-status {
                top: 10px;
                left: 10px;
                font-size: 0.75rem;
                padding: 6px 10px;
            }
        }

        @media (max-width: 480px) {
            .header-container {
                padding: 0.75rem;
            }

            .emergency-btn {
                min-height: 100px;
                padding: 0.75rem;
            }

            .emergency-btn .text-4xl {
                font-size: 1.875rem;
            }

            .emergency-btn .text-lg {
                font-size: 1rem;
            }

            .step-indicator {
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
            }

            .emergency-type-label {
                padding: 0.75rem;
            }

            .emergency-type-icon {
                font-size: 1.75rem;
            }

            .image-preview {
                width: 80px;
                height: 80px;
            }

            .alert-actions {
                flex-direction: column;
            }
        }

        /* Responsive styles for Rescue Centers section */
        @media (max-width: 768px) {
            .rescue-center-card .flex.justify-between.items-start {
                flex-direction: column;
            }

            .rescue-center-card .text-right {
                text-align: left;
                margin-top: 1rem;
                width: 100%;
            }

            .rescue-center-card .flex.items-center.mt-2 {
                flex-wrap: wrap;
            }

            .rescue-center-card .flex.items-center.mt-2>div {
                margin-bottom: 0.5rem;
                margin-right: 0.5rem;
            }

            #recommended-center .rescue-center-card .flex.justify-between.items-start {
                flex-direction: column;
            }

            #recommended-center .text-right {
                text-align: left;
                margin-top: 1rem;
            }

            #recommended-center .flex.items-center.mt-2 {
                flex-wrap: wrap;
            }

            #recommended-center .flex.items-center.mt-2>div {
                margin-bottom: 0.5rem;
                margin-right: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .rescue-center-card {
                padding: 0.75rem;
            }

            .rescue-center-card h3 {
                font-size: 1.125rem;
            }

            .rescue-center-card .text-xl {
                font-size: 1.25rem;
            }

            .rescue-center-card button {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }

            #recommended-center {
                padding: 0.75rem;
            }

            #recommended-center h3 {
                font-size: 1.125rem;
            }

            #recommended-center .text-xl {
                font-size: 1.25rem;
            }

            #recommended-center button {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
        }

        /* Additional utility classes for better responsiveness */
        .flex-wrap-responsive {
            flex-wrap: wrap;
        }

        .text-center-mobile {
            text-align: left;
        }

        @media (max-width: 768px) {
            .text-center-mobile {
                text-align: center;
            }

            .flex-responsive {
                flex-direction: column;
            }

            .px-responsive {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
        }
    </style>
</head>

<body class="min-h-screen text-gray-800">
    <!-- Connection Status Indicator -->
    <div id="connection-status" class="connection-status hidden">
        <span id="connection-indicator" class="online-indicator"></span>
        <span id="connection-text">Connected</span>
    </div>

    <!-- Alert Notification -->
    <div id="alert-notification" class="alert-notification">
        <div class="alert-header">
            <div class="alert-title">
                <i class="fas fa-bell alert-icon"></i>
                <span>NEW EMERGENCY ALERT</span>
            </div>
            <button class="alert-close" id="alert-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="alert-content">
            A new emergency has been reported and requires immediate attention.
        </div>
        <div class="alert-details">
            <div class="alert-detail-row">
                <span class="alert-detail-label">Type:</span>
                <span id="alert-type">Medical Emergency</span>
            </div>
            <div class="alert-detail-row">
                <span class="alert-detail-label">Location:</span>
                <span id="alert-location">Unknown Location</span>
            </div>
            <div class="alert-detail-row">
                <span class="alert-detail-label">Time:</span>
                <span id="alert-time">Just now</span>
            </div>
            <div class="alert-detail-row">
                <span class="alert-detail-label">Severity:</span>
                <span id="alert-severity">Critical</span>
            </div>
        </div>
        <div class="alert-actions">
            <button class="alert-btn alert-btn-primary" id="alert-view-details">
                View Details
            </button>
            <button class="alert-btn alert-btn-secondary" id="alert-dismiss">
                Dismiss
            </button>
        </div>
    </div>

    <!-- Sound Toggle Button -->
    <div class="alert-sound-toggle" id="sound-toggle">
        <i class="fas fa-volume-up"></i>
        <div class="alert-counter hidden" id="alert-counter">0</div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-center mb-4">
                    <div class="bg-red-600 p-3 rounded-full">
                        <i class="fas fa-ambulance text-white text-3xl"></i>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-center">Welcome to Zambia Emergency Response</h2>
                <p class="text-gray-600 text-center mt-2">Please choose how you want to use the system</p>
            </div>

            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="user-type-btn" data-type="reporter">
                        <div class="text-4xl mb-3 text-blue-600">
                            <i class="fas fa-user"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">Report Emergency</h3>
                        <p class="text-gray-600 text-sm">I need to report an emergency incident</p>
                    </div>

                    <div class="user-type-btn" data-type="responder">
                        <div class="text-4xl mb-3 text-red-600">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">Respond to Emergency</h3>
                        <p class="text-gray-600 text-sm">I'm a responder from a rescue center</p>
                    </div>

                    <div class="user-type-btn" data-type="guest">
                        <div class="text-4xl mb-3 text-green-600">
                            <i class="fas fa-user-clock"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">Continue as Guest</h3>
                        <p class="text-gray-600 text-sm">Quick emergency reporting without account</p>
                    </div>
                </div>

                <div id="reporter-login" class="hidden">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1 required-field">Phone Number</label>
                        <input type="tel" id="reporter-phone"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="+260 XXX XXX XXX">
                    </div>
                    <button id="reporter-login-btn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-semibold">
                        Continue as Reporter
                    </button>
                </div>

                <div id="responder-login" class="hidden">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1 required-field">Organization</label>
                        <select id="responder-org"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select your organization</option>
                            <option value="hospital">Hospital</option>
                            <option value="police">Police Station</option>
                            <option value="fire">Fire Station</option>
                            <option value="security">Security Company</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1 required-field">Email Address</label>
                        <input type="email" id="responder-email"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="your@email.com">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1 required-field">Password</label>
                        <input type="password" id="responder-password"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Enter your password">
                    </div>

                    <button id="responder-login-btn"
                        class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-semibold">
                        Login as Responder
                    </button>
                </div>

                <div id="guest-login" class="hidden">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-500 text-xl mt-1"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-blue-800">Guest Access</h3>
                                <div class="mt-2 text-sm text-blue-700">
                                    <p>As a guest, you can report emergencies and find nearby rescue centers. Some
                                        features may be limited.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="guest-login-btn"
                        class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-semibold">
                        Continue as Guest
                    </button>
                </div>
            </div>

            <div class="p-4 bg-gray-100 text-center">
                <p class="text-sm text-gray-600">By continuing, you agree to our <a href="#" class="text-blue-600">Terms
                        of Service</a> and <a href="#" class="text-blue-600">Privacy Policy</a></p>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center header-container">
            <div class="flex items-center space-x-3">
                <div class="bg-red-600 p-2 rounded-lg">
                    <i class="fas fa-ambulance text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">Zambia Emergency Response</h1>
                    <p class="text-xs text-gray-600">Citizen Emergency Reporting</p>
                </div>
            </div>
            <div class="flex items-center space-x-4 header-status">
                <div class="flex items-center space-x-2 bg-red-50 px-3 py-1 rounded-full">
                    <div class="w-3 h-3 bg-green-500 rounded-full pulse"></div>
                    <span class="text-sm font-medium" id="status">Ready to help</span>
                </div>
                <button id="user-menu"
                    class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg transition-colors">
                    <i class="fas fa-user-circle mr-1"></i> <span id="user-display">Guest</span>
                </button>
                <button id="logout-btn"
                    class="text-sm bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded-lg transition-colors hidden">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content - Reporter/Guest View -->
    <main id="reporter-view" class="container mx-auto px-4 py-6 hidden">
        <div class="max-w-4xl mx-auto">
            <!-- Progress Indicator -->
            <div class="emergency-card p-5 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="step-indicator completed">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="step-indicator active">2</div>
                        <div class="step-indicator">3</div>
                        <div class="step-indicator">4</div>
                    </div>
                    <div class="text-sm font-medium text-gray-600">Step <span id="current-step">2</span> of 4</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 25%"></div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-gray-600">
                    <div>Emergency Type</div>
                    <div>Details</div>
                    <div>Location</div>
                    <div>Confirmation</div>
                </div>
            </div>

            <!-- Form Navigation -->
            <div class="flex justify-between mb-6">
                <button id="prev-step"
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium flex items-center hidden">
                    <i class="fas fa-arrow-left mr-2"></i> Back
                </button>
                <button id="next-step"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium flex items-center ml-auto">
                    Next <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>

            <!-- Emergency Type Selection -->
            <div id="step-1" class="form-section active">
                <div class="emergency-card p-5 mb-6">
                    <h2 class="text-xl font-bold mb-2">What type of emergency are you reporting?</h2>
                    <p class="text-gray-600 mb-5">Select the category that best matches your emergency situation</p>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <input type="radio" name="emergency-type" id="medical-emergency" value="medical"
                            class="emergency-type-radio">
                        <label for="medical-emergency" class="emergency-type-label">
                            <div class="emergency-type-icon text-red-600">🏥</div>
                            <div class="text-lg font-semibold">MEDICAL</div>
                            <div class="text-xs opacity-80">Injury or illness</div>
                        </label>

                        <input type="radio" name="emergency-type" id="fire-emergency" value="fire"
                            class="emergency-type-radio">
                        <label for="fire-emergency" class="emergency-type-label">
                            <div class="emergency-type-icon text-orange-600">🔥</div>
                            <div class="text-lg font-semibold">FIRE</div>
                            <div class="text-xs opacity-80">Fire or explosion</div>
                        </label>

                        <input type="radio" name="emergency-type" id="police-emergency" value="police"
                            class="emergency-type-radio">
                        <label for="police-emergency" class="emergency-type-label">
                            <div class="emergency-type-icon text-blue-600">👮</div>
                            <div class="text-lg font-semibold">POLICE</div>
                            <div class="text-xs opacity-80">Crime in progress</div>
                        </label>

                        <input type="radio" name="emergency-type" id="general-emergency" value="general"
                            class="emergency-type-radio">
                        <label for="general-emergency" class="emergency-type-label">
                            <div class="emergency-type-icon text-yellow-600">⚠️</div>
                            <div class="text-lg font-semibold">OTHER</div>
                            <div class="text-xs opacity-80">Other emergency</div>
                        </label>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-500 text-xl mt-1"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-blue-800">Need immediate help?</h3>
                                <div class="mt-2 text-sm text-blue-700">
                                    <p>If this is a life-threatening emergency, call <strong>991</strong> directly for
                                        fastest response.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Details Form -->
            <div id="step-2" class="form-section">
                <div class="emergency-card p-5 mb-6">
                    <h2 class="text-xl font-bold mb-2">Emergency Details</h2>
                    <p class="text-gray-600 mb-5">Please provide details about the emergency situation</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 required-field">How many people
                                are affected?</label>
                            <select id="affected-people"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select number</option>
                                <option>1 person</option>
                                <option>2-5 people</option>
                                <option>6-10 people</option>
                                <option>More than 10 people</option>
                                <option>Not sure</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 required-field">Emergency
                                severity</label>
                            <select id="emergency-severity"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select severity</option>
                                <option>Critical - Life threatening</option>
                                <option>Serious - Needs urgent attention</option>
                                <option>Moderate - Needs medical attention</option>
                                <option>Minor - First aid required</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1 required-field">Emergency
                            description</label>
                        <textarea id="emergency-description"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            rows="3" placeholder="Please describe what happened..."></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Upload photos (optional)</label>
                        <div class="flex items-center justify-center w-full">
                            <label
                                class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i class="fas fa-cloud-upload-alt text-gray-400 text-2xl mb-2"></i>
                                    <p class="text-xs text-gray-500">Click to upload or drag and drop</p>
                                </div>
                                <input id="image-upload" type="file" class="hidden" multiple accept="image/*">
                            </label>
                        </div>
                        <div id="image-preview-container" class="image-preview-container mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Location Information -->
            <div id="step-3" class="form-section">
                <div class="emergency-card p-5 mb-6">
                    <h2 class="text-xl font-bold mb-2">Emergency Location</h2>
                    <p class="text-gray-600 mb-5">Please verify your location or provide address details</p>

                    <div class="mb-4">
                        <div id="map" class="mb-4"></div>
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-location-dot text-red-600 mr-1"></i>
                                <span id="location-status">Detecting your location...</span>
                            </div>
                            <button id="refresh-location" class="text-sm text-blue-600 font-medium flex items-center">
                                <i class="fas fa-sync-alt mr-1"></i> Refresh Location
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 required-field">Address
                                line</label>
                            <input type="text" id="emergency-address"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Street address">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Landmark (optional)</label>
                            <input type="text" id="emergency-landmark"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Nearby landmark">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div id="step-4" class="form-section">
                <div class="emergency-card p-5 mb-6" id="contact-info-section">
                    <h2 class="text-xl font-bold mb-2">Your Contact Information</h2>
                    <p class="text-gray-600 mb-5">Please provide your contact details for follow-up</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Your name</label>
                            <input type="text" id="reporter-name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Full name">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone number</label>
                            <input type="tel" id="reporter-contact-phone"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="+260 XXX XXX XXX">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Can responders contact you?</label>
                        <div class="flex space-x-4 mt-2">
                            <label class="inline-flex items-center">
                                <input type="radio" class="form-radio text-blue-600" name="contact" value="yes" checked>
                                <span class="ml-2">Yes, contact me</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" class="form-radio text-blue-600" name="contact" value="no">
                                <span class="ml-2">No, report anonymously</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Nearest Rescue Centers -->
                <div class="emergency-card p-5 mb-6">
                    <h2 class="text-xl font-bold mb-2">Nearest Rescue Centers</h2>
                    <p class="text-gray-600 mb-5">Based on your location and emergency type, we recommend contacting:
                    </p>

                    <div id="recommended-center" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center mb-2">
                            <h3 class="font-bold text-lg">Recommended Center</h3>
                            <span class="recommended-badge">RECOMMENDED</span>
                        </div>
                        <div class="rescue-center-card recommended-center">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 id="recommended-name" class="font-bold text-lg"></h3>
                                    <p id="recommended-distance" class="text-gray-600"></p>
                                    <div id="recommended-resources" class="flex items-center mt-2"></div>
                                </div>
                                <div class="text-right">
                                    <div id="recommended-phone" class="text-xl font-bold text-red-600"></div>
                                    <button
                                        class="mt-2 bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm call-center">
                                        <i class="fas fa-phone mr-1"></i> Call Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4" id="rescue-centers-list">
                        <!-- Rescue centers will be populated here -->
                    </div>

                    <button id="refresh-centers"
                        class="mt-4 w-full py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center justify-center">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh Nearby Centers
                    </button>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-between">
                    <button
                        class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>
                    <button id="submit-emergency"
                        class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium flex items-center">
                        Report Emergency <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Main Content - Responder View -->
    <main id="responder-view" class="container mx-auto px-4 py-6 hidden">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">Emergency Response Dashboard</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="emergency-card p-5 text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-2" id="active-emergencies">0</div>
                    <div class="text-gray-600">Active Emergencies</div>
                </div>

                <div class="emergency-card p-5 text-center">
                    <div class="text-3xl font-bold text-green-600 mb-2" id="responded-emergencies">0</div>
                    <div class="text-gray-600">Responded To</div>
                </div>

                <div class="emergency-card p-5 text-center">
                    <div class="text-3xl font-bold text-gray-600 mb-2" id="resolved-emergencies">0</div>
                    <div class="text-gray-600">Resolved</div>
                </div>
            </div>

            <div class="emergency-card p-5 mb-6">
                <h3 class="text-lg font-bold mb-4">Active Emergencies</h3>

                <div class="space-y-4" id="emergencies-list">
                    <!-- Emergencies will be populated here -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>No active emergencies at this time</p>
                    </div>
                </div>
            </div>

            <div class="emergency-card p-5">
                <h3 class="text-lg font-bold mb-4">Response Tools</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="view-map-btn"
                        class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium flex items-center justify-center">
                        <i class="fas fa-map-marker-alt mr-2"></i> View on Map
                    </button>

                    <button id="dispatch-unit-btn"
                        class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium flex items-center justify-center">
                        <i class="fas fa-ambulance mr-2"></i> Dispatch Unit
                    </button>
                </div>
            </div>
        </div>
        <!-- Analytics Section -->
        <div class="emergency-card p-5 mt-6">
            <h3 class="text-lg font-bold mb-4">Emergency Analytics</h3>

            <!-- Time Period Selector -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex space-x-2">
                    <button id="daily-report-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium">Daily
                        Report</button>
                    <button id="monthly-report-btn"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium">Monthly Report</button>
                </div>
                <div class="text-sm text-gray-600" id="report-period">Showing data for: Today</div>
            </div>

            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="total-emergencies">0</div>
                    <div class="text-sm text-gray-600">Total Emergencies</div>
                </div>
                <div class="bg-red-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-red-600" id="medical-emergencies">0</div>
                    <div class="text-sm text-gray-600">Medical Cases</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-orange-600" id="fire-emergencies">0</div>
                    <div class="text-sm text-gray-600">Fire Incidents</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="police-emergencies">0</div>
                    <div class="text-sm text-gray-600">Police Cases</div>
                </div>
            </div>

            <!-- Map Visualization -->
            <div class="mb-6">
                <h4 class="font-medium mb-2">Emergency Hotspots</h4>
                <div id="analytics-map" style="height: 300px; border-radius: 8px;"></div>
            </div>

            <!-- Emergency Type Distribution -->
            <div class="mb-6">
                <h4 class="font-medium mb-2">Emergency Type Distribution</h4>
                <div class="bg-white p-4 rounded-lg shadow">
                    <canvas id="type-chart" height="100"></canvas>
                </div>
            </div>

            <!-- Time Pattern Chart -->
            <div class="mb-6">
                <h4 class="font-medium mb-2">Emergency Patterns</h4>
                <div class="bg-white p-4 rounded-lg shadow">
                    <canvas id="time-chart" height="100"></canvas>
                </div>
            </div>

            <!-- Detailed Report Table -->
            <div>
                <h4 class="font-medium mb-2">Detailed Report</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg overflow-hidden">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-2 px-4 text-left">Time</th>
                                <th class="py-2 px-4 text-left">Type</th>
                                <th class="py-2 px-4 text-left">Location</th>
                                <th class="py-2 px-4 text-left">Severity</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Emergency Action Footer -->
    <footer class="bg-white border-t border-gray-200 mt-8 py-4">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                <div class="text-sm text-gray-600">
                    © 2025 Zambia Emergency Response System. All rights reserved. Developed by Edina Gabriella Ngalasa.
                </div>
                <div class="flex space-x-3">
                    <button class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg transition-colors">
                        <i class="fas fa-shield-alt mr-1"></i> Privacy
                    </button>
                    <button class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg transition-colors">
                        <i class="fas fa-file-alt mr-1"></i> Terms
                    </button>
                    <button class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg transition-colors">
                        <i class="fas fa-question-circle mr-1"></i> Help
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <!-- Emergency Call Button -->
    <div class="floating-action">
        <i class="fas fa-phone-alt text-xl"></i>
    </div>

    <!-- Calling Modal -->
    <div id="calling-modal" class="calling-modal hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="text-center">
                <div class="text-5xl text-red-600 mb-4 phone-ring">
                    <i class="fas fa-phone"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Calling Emergency Services</h2>
                <div id="calling-details" class="mb-4">
                    <p class="text-gray-600">Connecting to nearest dispatch center</p>
                </div>
                <div class="text-3xl font-mono font-bold text-red-600 mb-4">991</div>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-call"
                        class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-full font-semibold">
                        <i class="fas fa-phone mr-1"></i> Call
                    </button>
                    <button id="cancel-call"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-5 py-2 rounded-full font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="map-modal" class="map-modal hidden">
        <div class="map-modal-content">
            <div class="close-modal">
                <i class="fas fa-times"></i>
            </div>
            <h3 class="text-xl font-bold mb-4">Emergency Location Map</h3>
            <div id="emergency-map"></div>
        </div>
    </div>

    <!-- Dispatch Modal -->
    <div id="dispatch-modal" class="dispatch-modal hidden">
        <div class="dispatch-modal-content">
            <div class="close-modal">
                <i class="fas fa-times"></i>
            </div>
            <h3 class="text-xl font-bold mb-4">Dispatch Emergency Unit</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1 required-field">Select Unit</label>
                <select id="dispatch-unit"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Select a response unit</option>
                    <option value="unit-1">Ambulance Unit 1</option>
                    <option value="unit-2">Ambulance Unit 2</option>
                    <option value="unit-3">Police Patrol 1</option>
                    <option value="unit-4">Fire Truck 1</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
                <textarea id="dispatch-notes"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    rows="3" placeholder="Add any special instructions..."></textarea>
            </div>
            <button id="confirm-dispatch"
                class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-semibold">
                Confirm Dispatch
            </button>
        </div>
    </div>

    <script>
        // WebSocket connection for real-time functionality
        let ws = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const RECONNECT_INTERVAL = 3000; // 3 seconds

        // Initialize WebSocket connection
        function initWebSocket() {
            try {
                // In a real implementation, this would connect to your WebSocket server
                // For this demo, we'll simulate the connection
                ws = {
                    send: function (data) {
                        console.log('WebSocket message sent:', data);
                        // Simulate receiving messages after a short delay
                        setTimeout(() => {
                            handleWebSocketMessage(JSON.parse(data));
                        }, 100);
                    },
                    close: function () {
                        console.log('WebSocket connection closed');
                        isConnected = false;
                        updateConnectionStatus(false);
                    }
                };

                // Simulate successful connection
                setTimeout(() => {
                    isConnected = true;
                    updateConnectionStatus(true);

                    // Send user info to server
                    if (currentUser) {
                        sendUserInfo();
                    }

                    // If responder, request current emergencies
                    if (currentUser && currentUser.type === 'responder') {
                        requestEmergencies();
                    }
                }, 500);

            } catch (error) {
                console.error('WebSocket connection failed:', error);
                handleConnectionError();
            }
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(message) {
            console.log('WebSocket message received:', message);

            switch (message.type) {
                case 'user_joined':
                    showNotification(`${message.userName} joined the system`, 'info');
                    break;

                case 'user_left':
                    showNotification(`${message.userName} left the system`, 'info');
                    break;

                case 'emergency_reported':
                    handleNewEmergency(message.emergency);
                    break;

                case 'emergency_updated':
                    updateEmergency(message.emergency);
                    break;

                case 'emergency_resolved':
                    resolveEmergency(message.emergencyId);
                    break;

                case 'emergencies_list':
                    if (currentUser && currentUser.type === 'responder') {
                        updateEmergenciesList(message.emergencies);
                    }
                    break;

                case 'user_info_updated':
                    updateUserInfo(message.user);
                    break;

                default:
                    console.log('Unknown message type:', message.type);
            }
        }

        // Send user information to server
        function sendUserInfo() {
            if (!ws || !isConnected || !currentUser) return;

            const message = {
                type: 'user_info',
                user: {
                    id: currentUser.id || Date.now(),
                    name: currentUser.name,
                    type: currentUser.type,
                    organization: currentUser.organization,
                    location: userLocation,
                    timestamp: new Date().toISOString()
                }
            };

            ws.send(JSON.stringify(message));
        }

        // Request current emergencies from server
        function requestEmergencies() {
            if (!ws || !isConnected) return;

            const message = {
                type: 'request_emergencies'
            };

            ws.send(JSON.stringify(message));
        }

        // Report a new emergency
        function reportEmergency(emergency) {
            if (!ws || !isConnected) return;

            const message = {
                type: 'report_emergency',
                emergency: emergency
            };

            ws.send(JSON.stringify(message));
        }

        // Update emergency status
        function updateEmergencyStatus(emergencyId, status, responder = null) {
            if (!ws || !isConnected) return;

            const message = {
                type: 'update_emergency',
                emergencyId: emergencyId,
                status: status,
                responder: responder,
                timestamp: new Date().toISOString()
            };

            ws.send(JSON.stringify(message));
        }

        // Handle new emergency from server
        function handleNewEmergency(emergency) {
            // Add to local database
            emergencyDB.emergencies.push(emergency);

            // If user is a responder, update the UI
            if (currentUser && currentUser.type === 'responder') {
                loadEmergencies();
                showAlert(emergency);

                // Update analytics
                loadAnalyticsData();
            }

            // Show notification for reporters/guests if it's their emergency
            if (currentUser && (currentUser.type === 'reporter' || currentUser.type === 'guest') &&
                emergency.reporter.name === currentUser.name) {
                showNotification('Your emergency has been received and help is on the way!', 'success');
            }
        }

        // Update existing emergency
        function updateEmergency(emergency) {
            const index = emergencyDB.emergencies.findIndex(e => e.id === emergency.id);
            if (index !== -1) {
                emergencyDB.emergencies[index] = emergency;

                // If user is a responder, update the UI
                if (currentUser && currentUser.type === 'responder') {
                    loadEmergencies();
                }

                // Update analytics
                loadAnalyticsData();
            }
        }

        // Resolve emergency
        function resolveEmergency(emergencyId) {
            const index = emergencyDB.emergencies.findIndex(e => e.id === emergencyId);
            if (index !== -1) {
                emergencyDB.emergencies[index].status = 'resolved';

                // If user is a responder, update the UI
                if (currentUser && currentUser.type === 'responder') {
                    loadEmergencies();
                }

                // Update analytics
                loadAnalyticsData();

                // Show notification if it's the reporter's emergency
                if (currentUser && (currentUser.type === 'reporter' || currentUser.type === 'guest') &&
                    emergencyDB.emergencies[index].reporter.name === currentUser.name) {
                    showNotification('Your emergency has been resolved!', 'success');
                }
            }
        }

        // Update emergencies list for responders
        function updateEmergenciesList(emergencies) {
            emergencyDB.emergencies = emergencies;
            loadEmergencies();
            loadAnalyticsData();
        }

        // Update user information
        function updateUserInfo(user) {
            // In a real implementation, you might update user lists or online status
            console.log('User info updated:', user);
        }

        // Handle connection errors
        function handleConnectionError() {
            isConnected = false;
            updateConnectionStatus(false);

            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                console.log(`Attempting to reconnect... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);

                setTimeout(() => {
                    initWebSocket();
                }, RECONNECT_INTERVAL);
            } else {
                console.error('Max reconnection attempts reached');
                showNotification('Connection lost. Please refresh the page.', 'error');
            }
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            const indicatorEl = document.getElementById('connection-indicator');
            const textEl = document.getElementById('connection-text');

            if (connected) {
                statusEl.classList.remove('hidden');
                indicatorEl.className = 'online-indicator';
                textEl.textContent = 'Connected';
                reconnectAttempts = 0;
            } else {
                statusEl.classList.remove('hidden');
                indicatorEl.className = 'offline-indicator';
                textEl.textContent = 'Disconnected';
            }
        }

        // Data storage (simulating a database)
        const emergencyDB = {
            emergencies: [],
            responders: [
                {
                    id: 1,
                    email: "responder@uth.gov.zm",
                    password: "password123",
                    organization: "hospital",
                    name: "Dr. David Chanda",
                    badgeId: "UTH-1234",
                    isAvailable: true
                },
                {
                    id: 2,
                    email: "officer@police.gov.zm",
                    password: "password123",
                    organization: "police",
                    name: "Officer James Banda",
                    badgeId: "LCP-5678",
                    isAvailable: true
                },
                {
                    id: 3,
                    email: "firefighter@lusfire.gov.zm",
                    password: "fire123",
                    organization: "fire",
                    name: "Captain Sarah Mwale",
                    badgeId: "LFF-4567",
                    isAvailable: true
                },
                {
                    id: 4,
                    email: "guard@security.gov.zm",
                    password: "secure456",
                    organization: "security",
                    name: "Security Chief John Phiri",
                    badgeId: "GS-8965",
                    isAvailable: true
                }
            ],
            rescueCenters: [
                {
                    id: 1,
                    name: "University Teaching Hospital",
                    type: "hospital",
                    location: { lat: -15.3955, lng: 28.3200 },
                    address: "Nationalist Road, Lusaka, Zambia",
                    phone: "+260211256067",
                    resources: {
                        bedsAvailable: 12,
                        doctorsOnDuty: 4
                    },
                    emergencyTypes: ["medical", "general"]
                },
                {
                    id: 2,
                    name: "Lusaka Central Police Station",
                    type: "police",
                    location: { lat: -15.4167, lng: 28.2833 },
                    address: "Cairo Road, Lusaka, Zambia",
                    phone: "+260211228794",
                    resources: {
                        officersAvailable: 8,
                        vehiclesAvailable: 3
                    },
                    emergencyTypes: ["police", "general"]
                },
                {
                    id: 3,
                    name: "Lusaka Fire Station",
                    type: "fire",
                    location: { lat: -15.4100, lng: 28.2900 },
                    address: "Kabulonga Road, Lusaka, Zambia",
                    phone: "+260211228844",
                    resources: {
                        trucksAvailable: 2,
                        firefightersOnDuty: 6
                    },
                    emergencyTypes: ["fire", "general"]
                },
                {
                    id: 4,
                    name: "Levy Mwanawasa Hospital",
                    type: "hospital",
                    location: { lat: -15.3775, lng: 28.3100 },
                    address: "Great East Road, Lusaka, Zambia",
                    phone: "+260211253077",
                    resources: {
                        bedsAvailable: 8,
                        doctorsOnDuty: 3
                    },
                    emergencyTypes: ["medical", "general"]
                },
                {
                    id: 5,
                    name: "Woodlands Police Station",
                    type: "police",
                    location: { lat: -15.4000, lng: 28.3000 },
                    address: "Woodlands Road, Lusaka, Zambia",
                    phone: "+260211254321",
                    resources: {
                        officersAvailable: 5,
                        vehiclesAvailable: 2
                    },
                    emergencyTypes: ["police", "general"]
                }
            ]
        };

        // Current user state
        let currentUser = null;
        let currentEmergencyType = null;
        let userLocation = null;
        let map = null;
        let userMarker = null;
        let recommendedCenter = null;
        let emergencyRefreshInterval = null;
        let currentCallNumber = null;
        let currentStep = 1;
        let uploadedImages = [];
        let emergencyMap = null;
        let selectedEmergencyForDispatch = null;

        // Alert notification variables
        let alertSoundEnabled = true;
        let alertSound = null;
        let alertCounter = 0;
        let pendingAlerts = [];
        let currentAlert = null;
        let alertInterval = null;
        let alertDuration = 5 * 60 * 1000; // 5 minutes in milliseconds

        // Analytics variables
        let analyticsMap = null;
        let typeChart = null;
        let timeChart = null;
        let currentReportType = 'daily';

        // Session management
        const SESSION_DURATION = 10 * 60 * 1000; // 10 minutes

        // DOM Elements
        const loginModal = document.getElementById('login-modal');
        const reporterView = document.getElementById('reporter-view');
        const responderView = document.getElementById('responder-view');
        const logoutBtn = document.getElementById('logout-btn');
        const userDisplay = document.getElementById('user-display');
        const rescueCentersList = document.getElementById('rescue-centers-list');
        const recommendedCenterSection = document.getElementById('recommended-center');
        const recommendedName = document.getElementById('recommended-name');
        const recommendedDistance = document.getElementById('recommended-distance');
        const recommendedResources = document.getElementById('recommended-resources');
        const recommendedPhone = document.getElementById('recommended-phone');
        const emergenciesList = document.getElementById('emergencies-list');
        const activeEmergenciesEl = document.getElementById('active-emergencies');
        const respondedEmergenciesEl = document.getElementById('responded-emergencies');
        const resolvedEmergenciesEl = document.getElementById('resolved-emergencies');
        const contactInfoSection = document.getElementById('contact-info-section');
        const prevStepBtn = document.getElementById('prev-step');
        const nextStepBtn = document.getElementById('next-step');
        const currentStepEl = document.getElementById('current-step');
        const progressFill = document.getElementById('progress-fill');
        const formSections = document.querySelectorAll('.form-section');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const viewMapBtn = document.getElementById('view-map-btn');
        const dispatchUnitBtn = document.getElementById('dispatch-unit-btn');
        const mapModal = document.getElementById('map-modal');
        const dispatchModal = document.getElementById('dispatch-modal');
        const confirmDispatchBtn = document.getElementById('confirm-dispatch');
        const emergencyMapContainer = document.getElementById('emergency-map');

        // Alert notification elements
        const alertNotification = document.getElementById('alert-notification');
        const alertClose = document.getElementById('alert-close');
        const alertType = document.getElementById('alert-type');
        const alertLocation = document.getElementById('alert-location');
        const alertTime = document.getElementById('alert-time');
        const alertSeverity = document.getElementById('alert-severity');
        const alertViewDetails = document.getElementById('alert-view-details');
        const alertDismiss = document.getElementById('alert-dismiss');
        const soundToggle = document.getElementById('sound-toggle');
        const alertCounterEl = document.getElementById('alert-counter');

        // Analytics elements
        const dailyReportBtn = document.getElementById('daily-report-btn');
        const monthlyReportBtn = document.getElementById('monthly-report-btn');
        const reportPeriod = document.getElementById('report-period');
        const totalEmergenciesEl = document.getElementById('total-emergencies');
        const medicalEmergenciesEl = document.getElementById('medical-emergencies');
        const fireEmergenciesEl = document.getElementById('fire-emergencies');
        const policeEmergenciesEl = document.getElementById('police-emergencies');
        const reportTableBody = document.getElementById('report-table-body');

        // Show login modal on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize WebSocket connection
            initWebSocket();

            checkSession();
            initMap();
            setupCallButtons();
            setupFormNavigation();
            setupImageUpload();
            setupModalEvents();
            setupAlertSystem();
            setupAnalytics();
        });

        // Session management functions
        function checkSession() {
            const sessionData = localStorage.getItem('emergencyResponseSession');
            if (sessionData) {
                const session = JSON.parse(sessionData);
                const now = new Date().getTime();

                if (now - session.timestamp < SESSION_DURATION) {
                    // Session is valid, restore user
                    currentUser = session.user;
                    userDisplay.textContent = currentUser.name;
                    loginModal.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');

                    if (currentUser.type === 'reporter') {
                        reporterView.classList.remove('hidden');
                        contactInfoSection.classList.remove('hidden');
                    } else if (currentUser.type === 'responder') {
                        responderView.classList.remove('hidden');
                        // Load emergencies and set up auto-refresh
                        loadEmergencies();
                        if (emergencyRefreshInterval) {
                            clearInterval(emergencyRefreshInterval);
                        }
                        emergencyRefreshInterval = setInterval(loadEmergencies, 5000);
                        initAnalytics();
                    }

                    // Send user info to server
                    sendUserInfo();
                } else {
                    // Session expired
                    localStorage.removeItem('emergencyResponseSession');
                }
            }
        }

        function saveSession() {
            if (currentUser) {
                const session = {
                    user: currentUser,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem('emergencyResponseSession', JSON.stringify(session));
            }
        }

        function clearSession() {
            localStorage.removeItem('emergencyResponseSession');
        }

        // Setup analytics
        function setupAnalytics() {
            // Set up report type buttons
            dailyReportBtn.addEventListener('click', function () {
                currentReportType = 'daily';
                updateReportButtons();
                loadAnalyticsData();
            });

            monthlyReportBtn.addEventListener('click', function () {
                currentReportType = 'monthly';
                updateReportButtons();
                loadAnalyticsData();
            });
        }

        function initAnalytics() {
            loadAnalyticsData();
        }

        // Update report button styles
        function updateReportButtons() {
            if (currentReportType === 'daily') {
                dailyReportBtn.classList.add('bg-blue-600', 'text-white');
                dailyReportBtn.classList.remove('bg-gray-200', 'text-gray-700');
                monthlyReportBtn.classList.add('bg-gray-200', 'text-gray-700');
                monthlyReportBtn.classList.remove('bg-blue-600', 'text-white');
                reportPeriod.textContent = 'Showing data for: Today';
            } else {
                monthlyReportBtn.classList.add('bg-blue-600', 'text-white');
                monthlyReportBtn.classList.remove('bg-gray-200', 'text-gray-700');
                dailyReportBtn.classList.add('bg-gray-200', 'text-gray-700');
                dailyReportBtn.classList.remove('bg-blue-600', 'text-white');
                reportPeriod.textContent = 'Showing data for: This Month';
            }
        }

        // Load and process analytics data
        function loadAnalyticsData() {
            // Filter emergencies based on report type
            const now = new Date();
            let filteredEmergencies = [];

            if (currentReportType === 'daily') {
                // Get emergencies from today
                filteredEmergencies = emergencyDB.emergencies.filter(emergency => {
                    const emergencyDate = new Date(emergency.timestamp);
                    return emergencyDate.toDateString() === now.toDateString();
                });
            } else {
                // Get emergencies from this month
                filteredEmergencies = emergencyDB.emergencies.filter(emergency => {
                    const emergencyDate = new Date(emergency.timestamp);
                    return emergencyDate.getMonth() === now.getMonth() &&
                        emergencyDate.getFullYear() === now.getFullYear();
                });
            }

            // Update summary statistics
            updateSummaryStats(filteredEmergencies);

            // Update map visualization
            updateAnalyticsMap(filteredEmergencies);

            // Update charts
            updateTypeChart(filteredEmergencies);
            updateTimeChart(filteredEmergencies);

            // Update report table
            updateReportTable(filteredEmergencies);
        }

        // Update summary statistics
        function updateSummaryStats(emergencies) {
            totalEmergenciesEl.textContent = emergencies.length;

            const medicalCount = emergencies.filter(e => e.type === 'medical').length;
            const fireCount = emergencies.filter(e => e.type === 'fire').length;
            const policeCount = emergencies.filter(e => e.type === 'police').length;
            const otherCount = emergencies.filter(e => e.type === 'general').length;

            medicalEmergenciesEl.textContent = medicalCount;
            fireEmergenciesEl.textContent = fireCount;
            policeEmergenciesEl.textContent = policeCount;
        }

        // Update analytics map with emergency hotspots
        function updateAnalyticsMap(emergencies) {
            const mapContainer = document.getElementById('analytics-map');

            // Clear previous map if it exists
            if (analyticsMap) {
                analyticsMap.remove();
            }

            // Create new map centered on Lusaka
            analyticsMap = L.map('analytics-map').setView([-15.3875, 28.3228], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(analyticsMap);

            // Create a heatmap layer (using circles as a simple approximation)
            emergencies.forEach(emergency => {
                let color;
                switch (emergency.type) {
                    case 'medical': color = 'red'; break;
                    case 'fire': color = 'orange'; break;
                    case 'police': color = 'blue'; break;
                    default: color = 'gray';
                }

                L.circle([emergency.location.lat, emergency.location.lng], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.5,
                    radius: 300
                }).addTo(analyticsMap).bindPopup(`
                    <strong>${emergency.type.toUpperCase()} Emergency</strong><br>
                    ${emergency.address}<br>
                    ${formatTime(emergency.timestamp)}
                `);
            });

            // Add rescue centers to the map
            emergencyDB.rescueCenters.forEach(center => {
                let iconColor;
                switch (center.type) {
                    case 'hospital': iconColor = 'red'; break;
                    case 'police': iconColor = 'blue'; break;
                    case 'fire': iconColor = 'orange'; break;
                    default: iconColor = 'gray';
                }

                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div style="background-color: ${iconColor}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                L.marker([center.location.lat, center.location.lng], { icon: icon })
                    .addTo(analyticsMap)
                    .bindPopup(`
                        <strong>${center.name}</strong><br>
                        ${center.address}<br>
                        Phone: ${center.phone}
                    `);
            });
        }

        // Update emergency type distribution chart
        function updateTypeChart(emergencies) {
            const ctx = document.getElementById('type-chart').getContext('2d');

            // Count emergencies by type
            const typeCounts = {
                medical: emergencies.filter(e => e.type === 'medical').length,
                fire: emergencies.filter(e => e.type === 'fire').length,
                police: emergencies.filter(e => e.type === 'police').length,
                general: emergencies.filter(e => e.type === 'general').length
            };

            // Destroy previous chart if it exists
            if (typeChart) {
                typeChart.destroy();
            }

            // Create new chart
            typeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Medical', 'Fire', 'Police', 'Other'],
                    datasets: [{
                        data: [typeCounts.medical, typeCounts.fire, typeCounts.police, typeCounts.general],
                        backgroundColor: [
                            '#ef4444', // red
                            '#f97316', // orange
                            '#3b82f6', // blue
                            '#94a3b8'  // gray
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Update time pattern chart
        function updateTimeChart(emergencies) {
            const ctx = document.getElementById('time-chart').getContext('2d');

            // Group emergencies by hour
            const hours = Array.from({ length: 24 }, (_, i) => i);
            const hourlyCounts = hours.map(hour => {
                return emergencies.filter(emergency => {
                    const emergencyHour = new Date(emergency.timestamp).getHours();
                    return emergencyHour === hour;
                }).length;
            });

            // Destroy previous chart if it exists
            if (timeChart) {
                timeChart.destroy();
            }

            // Create new chart
            timeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [{
                        label: 'Emergencies by Hour',
                        data: hourlyCounts,
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Emergencies'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        }
                    }
                }
            });
        }

        // Update detailed report table
        function updateReportTable(emergencies) {
            reportTableBody.innerHTML = '';

            // Sort emergencies by timestamp (newest first)
            const sortedEmergencies = [...emergencies].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            // Add rows to table
            sortedEmergencies.forEach(emergency => {
                const row = document.createElement('tr');

                // Format time
                const emergencyTime = new Date(emergency.timestamp);
                const timeString = emergencyTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Format type with icon
                let typeIcon = '';
                switch (emergency.type) {
                    case 'medical': typeIcon = '🏥'; break;
                    case 'fire': typeIcon = '🔥'; break;
                    case 'police': typeIcon = '👮'; break;
                    default: typeIcon = '⚠️';
                }

                row.innerHTML = `
                    <td class="py-2 px-4">${timeString}</td>
                    <td class="py-2 px-4">${typeIcon} ${emergency.type.charAt(0).toUpperCase() + emergency.type.slice(1)}</td>
                    <td class="py-2 px-4">${emergency.address}</td>
                    <td class="py-2 px-4">
                        <span class="priority-badge ${getSeverityClass(emergency.severity)}">
                            ${emergency.severity}
                        </span>
                    </td>
                `;

                reportTableBody.appendChild(row);
            });

            // If no emergencies, show message
            if (sortedEmergencies.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="4" class="py-4 px-4 text-center text-gray-500">
                        No emergencies found for this period
                    </td>
                `;
                reportTableBody.appendChild(row);
            }
        }

        // Helper function to get severity CSS class
        function getSeverityClass(severity) {
            if (severity.includes('Critical')) return 'bg-red-100 text-red-800';
            if (severity.includes('Serious')) return 'bg-yellow-100 text-yellow-800';
            if (severity.includes('Moderate')) return 'bg-blue-100 text-blue-800';
            return 'bg-gray-100 text-gray-800';
        }

        // Setup alert notification system
        function setupAlertSystem() {
            // Setup alert event listeners
            alertClose.addEventListener('click', hideAlert);
            alertDismiss.addEventListener('click', hideAlert);
            alertViewDetails.addEventListener('click', function () {
                if (currentAlert) {
                    // Select the emergency in the list
                    const emergencyItem = document.querySelector(`.emergency-item[data-id="${currentAlert.id}"]`);
                    if (emergencyItem) {
                        emergencyItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        emergencyItem.classList.add('selected');

                        // Highlight the emergency for a moment
                        setTimeout(() => {
                            emergencyItem.style.backgroundColor = '#fff3cd';
                            setTimeout(() => {
                                emergencyItem.style.backgroundColor = '';
                            }, 3000);
                        }, 100);
                    }
                }
                hideAlert();
            });

            // Sound toggle
            soundToggle.addEventListener('click', function () {
                alertSoundEnabled = !alertSoundEnabled;
                if (alertSoundEnabled) {
                    soundToggle.classList.remove('muted');
                    soundToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
                } else {
                    soundToggle.classList.add('muted');
                    soundToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
                }
            });

            // Check for new emergencies periodically
            setInterval(checkForNewEmergencies, 3000);
        }

        // Check for new emergencies and trigger alerts
        function checkForNewEmergencies() {
            // Only check if user is a responder
            if (!currentUser || currentUser.type !== 'responder') return;

            // Get the latest emergency ID we've seen
            const latestSeenId = localStorage.getItem('latestSeenEmergencyId') || 0;

            // Find new emergencies (those with ID greater than latest seen)
            const newEmergencies = emergencyDB.emergencies.filter(
                emergency => emergency.id > latestSeenId && emergency.status === 'reported'
            );

            // Update the latest seen ID
            if (emergencyDB.emergencies.length > 0) {
                const maxId = Math.max(...emergencyDB.emergencies.map(e => e.id));
                localStorage.setItem('latestSeenEmergencyId', maxId);
            }

            // Show alerts for new emergencies
            newEmergencies.forEach(emergency => {
                showAlert(emergency);
            });
        }

        // Show alert for a new emergency
        function showAlert(emergency) {
            // If there's already an alert showing, add to pending queue
            if (alertNotification.classList.contains('show')) {
                pendingAlerts.push(emergency);
                updateAlertCounter();
                return;
            }

            currentAlert = emergency;

            // Update alert content
            alertType.textContent = emergency.type.charAt(0).toUpperCase() + emergency.type.slice(1) + ' Emergency';
            alertLocation.textContent = emergency.address;
            alertTime.textContent = formatTime(emergency.timestamp);
            alertSeverity.textContent = emergency.severity;

            // Add severity-based styling
            alertSeverity.className = '';
            if (emergency.severity.includes('Critical')) {
                alertSeverity.classList.add('priority-badge', 'bg-red-100', 'text-red-800');
            } else if (emergency.severity.includes('Serious')) {
                alertSeverity.classList.add('priority-badge', 'bg-yellow-100', 'text-yellow-800');
            } else if (emergency.severity.includes('Moderate')) {
                alertSeverity.classList.add('priority-badge', 'bg-blue-100', 'text-blue-800');
            } else {
                alertSeverity.classList.add('priority-badge', 'bg-gray-100', 'text-gray-800');
            }

            // Show the alert
            alertNotification.classList.add('show', 'pulse');

            // Play alert sound if enabled
            if (alertSoundEnabled) {
                playAlertSound();
                // Continue playing sound every 10 seconds for 5 minutes
                alertInterval = setInterval(() => {
                    if (alertSoundEnabled && alertNotification.classList.contains('show')) {
                        playAlertSound();
                    }
                }, 10000);
            }

            // Auto-hide after 5 minutes if not interacted with
            setTimeout(() => {
                if (alertNotification.classList.contains('show')) {
                    hideAlert();
                }
            }, alertDuration);
        }

        // Hide the current alert and show next if available
        function hideAlert() {
            alertNotification.classList.remove('show', 'pulse');
            currentAlert = null;

            // Clear the alert interval
            if (alertInterval) {
                clearInterval(alertInterval);
                alertInterval = null;
            }

            // Show next alert if available
            if (pendingAlerts.length > 0) {
                setTimeout(() => {
                    const nextAlert = pendingAlerts.shift();
                    showAlert(nextAlert);
                    updateAlertCounter();
                }, 500);
            }
        }

        // Play alert sound
        function playAlertSound() {
            if (alertSoundEnabled) {
                // Create a simple beep sound using Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);

                    // Repeat after a short delay
                    setTimeout(() => {
                        const oscillator2 = audioContext.createOscillator();
                        const gainNode2 = audioContext.createGain();

                        oscillator2.connect(gainNode2);
                        gainNode2.connect(audioContext.destination);

                        oscillator2.frequency.value = 600;
                        oscillator2.type = 'sine';

                        gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                        oscillator2.start(audioContext.currentTime);
                        oscillator2.stop(audioContext.currentTime + 0.5);
                    }, 600);
                } catch (e) {
                    console.error('Error playing alert sound:', e);
                }
            }
        }

        // Update alert counter badge
        function updateAlertCounter() {
            alertCounter = pendingAlerts.length;
            if (alertCounter > 0) {
                alertCounterEl.textContent = alertCounter;
                alertCounterEl.classList.remove('hidden');
            } else {
                alertCounterEl.classList.add('hidden');
            }
        }

        // Setup image upload functionality
        function setupImageUpload() {
            imageUpload.addEventListener('change', function (e) {
                const files = e.target.files;
                if (!files || files.length === 0) return;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (!file.type.match('image.*')) continue;

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const imageData = e.target.result;
                        uploadedImages.push(imageData);

                        // Create preview
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'image-preview';
                        previewDiv.innerHTML = `
                            <img src="${imageData}" alt="Uploaded image">
                            <div class="remove-image" data-index="${uploadedImages.length - 1}">
                                <i class="fas fa-times"></i>
                            </div>
                        `;
                        imagePreviewContainer.appendChild(previewDiv);

                        // Add event listener to remove button
                        const removeBtn = previewDiv.querySelector('.remove-image');
                        removeBtn.addEventListener('click', function () {
                            const index = parseInt(this.getAttribute('data-index'));
                            uploadedImages.splice(index, 1);
                            imagePreviewContainer.removeChild(previewDiv);

                            // Update indices for remaining remove buttons
                            const remainingButtons = imagePreviewContainer.querySelectorAll('.remove-image');
                            remainingButtons.forEach((btn, idx) => {
                                btn.setAttribute('data-index', idx);
                            });
                        });
                    };
                    reader.readAsDataURL(file);
                }

                // Reset the file input
                imageUpload.value = '';
            });
        }

        // Setup modal events
        function setupModalEvents() {
            // Close modals when clicking the close button
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function () {
                    mapModal.classList.add('hidden');
                    dispatchModal.classList.add('hidden');
                });
            });

            // Close modals when clicking outside the content
            mapModal.addEventListener('click', function (e) {
                if (e.target === mapModal) {
                    mapModal.classList.add('hidden');
                }
            });

            dispatchModal.addEventListener('click', function (e) {
                if (e.target === dispatchModal) {
                    dispatchModal.classList.add('hidden');
                }
            });

            // View map button
            viewMapBtn.addEventListener('click', function () {
                // Check if an emergency is selected
                const selectedEmergency = document.querySelector('.emergency-item.selected');
                if (!selectedEmergency) {
                    showNotification('Please select an emergency first', 'error');
                    return;
                }

                const emergencyId = parseInt(selectedEmergency.getAttribute('data-id'));
                const emergency = emergencyDB.emergencies.find(e => e.id === emergencyId);

                if (emergency) {
                    showEmergencyMap(emergency);
                    mapModal.classList.remove('hidden');
                }
            });

            // Dispatch unit button
            dispatchUnitBtn.addEventListener('click', function () {
                // Check if an emergency is selected
                const selectedEmergency = document.querySelector('.emergency-item.selected');
                if (!selectedEmergency) {
                    showNotification('Please select an emergency first', 'error');
                    return;
                }

                const emergencyId = parseInt(selectedEmergency.getAttribute('data-id'));
                selectedEmergencyForDispatch = emergencyDB.emergencies.find(e => e.id === emergencyId);

                if (selectedEmergencyForDispatch) {
                    dispatchModal.classList.remove('hidden');
                }
            });

            // Confirm dispatch
            confirmDispatchBtn.addEventListener('click', function () {
                const unit = document.getElementById('dispatch-unit').value;
                const notes = document.getElementById('dispatch-notes').value;

                if (!unit) {
                    showNotification('Please select a unit to dispatch', 'error');
                    return;
                }

                // Update emergency status
                selectedEmergencyForDispatch.status = 'dispatched';
                selectedEmergencyForDispatch.dispatchedUnit = unit;
                selectedEmergencyForDispatch.dispatchNotes = notes;
                selectedEmergencyForDispatch.dispatchTime = new Date();

                // Send update to server
                updateEmergencyStatus(selectedEmergencyForDispatch.id, 'dispatched', currentUser.name);

                showNotification(`Unit ${unit} has been dispatched to the emergency`, 'success');
                dispatchModal.classList.add('hidden');

                // Refresh emergencies list
                loadEmergencies();
                // Refresh analytics
                loadAnalyticsData();
            });
        }

        // Show emergency on map
        function showEmergencyMap(emergency) {
            // Clear previous map if it exists
            if (emergencyMap) {
                emergencyMap.remove();
            }

            // Create new map
            emergencyMap = L.map('emergency-map').setView([emergency.location.lat, emergency.location.lng], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(emergencyMap);

            // Add marker for emergency location
            L.marker([emergency.location.lat, emergency.location.lng])
                .addTo(emergencyMap)
                .bindPopup(`
                    <strong>${emergency.type.toUpperCase()} Emergency</strong><br>
                    ${emergency.address}<br>
                    ${emergency.landmark ? `Landmark: ${emergency.landmark}<br>` : ''}
                    Reported: ${formatTime(emergency.timestamp)}
                `)
                .openPopup();

            // Add nearby rescue centers to the map
            emergencyDB.rescueCenters.forEach(center => {
                let iconColor;
                switch (center.type) {
                    case 'hospital': iconColor = 'red'; break;
                    case 'police': iconColor = 'blue'; break;
                    case 'fire': iconColor = 'orange'; break;
                    default: iconColor = 'gray';
                }

                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div style="background-color: ${iconColor}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                L.marker([center.location.lat, center.location.lng], { icon: icon })
                    .addTo(emergencyMap)
                    .bindPopup(`
                        <strong>${center.name}</strong><br>
                        ${center.address}<br>
                        Phone: ${center.phone}
                    `);
            });
        }

        // Setup form navigation
        function setupFormNavigation() {
            prevStepBtn.addEventListener('click', goToPreviousStep);
            nextStepBtn.addEventListener('click', goToNextStep);
        }

        // Navigate to next step
        function goToNextStep() {
            // Validate current step
            if (!validateCurrentStep()) {
                return;
            }

            if (currentStep < 4) {
                // Hide current section
                document.getElementById(`step-${currentStep}`).classList.remove('active');

                // Show next section
                currentStep++;
                document.getElementById(`step-${currentStep}`).classList.add('active');

                // Update UI
                updateStepUI();

                // If we're on the final step, load rescue centers
                if (currentStep === 4) {
                    loadRescueCenters();
                }
            } else {
                // Submit the form if we're on the last step
                document.getElementById('submit-emergency').click();
            }
        }

        // Navigate to previous step
        function goToPreviousStep() {
            if (currentStep > 1) {
                // Hide current section
                document.getElementById(`step-${currentStep}`).classList.remove('active');

                // Show previous section
                currentStep--;
                document.getElementById(`step-${currentStep}`).classList.add('active');

                // Update UI
                updateStepUI();
            }
        }

        // Update step UI elements
        function updateStepUI() {
            // Update progress bar
            const progressPercentage = (currentStep / 4) * 100;
            progressFill.style.width = `${progressPercentage}%`;

            // Update step indicator
            currentStepEl.textContent = currentStep;

            // Update navigation buttons
            if (currentStep === 1) {
                prevStepBtn.classList.add('hidden');
            } else {
                prevStepBtn.classList.remove('hidden');
            }

            if (currentStep === 4) {
                nextStepBtn.textContent = 'Submit Report';
                nextStepBtn.innerHTML = 'Submit Report <i class="fas fa-check ml-2"></i>';
            } else {
                nextStepBtn.textContent = 'Next';
                nextStepBtn.innerHTML = 'Next <i class="fas fa-arrow-right ml-2"></i>';
            }
        }

        // Validate current step
        function validateCurrentStep() {
            switch (currentStep) {
                case 1: // Emergency type
                    const selectedType = document.querySelector('input[name="emergency-type"]:checked');
                    if (!selectedType) {
                        showNotification('Please select an emergency type', 'error');
                        return false;
                    }
                    currentEmergencyType = selectedType.value;
                    return true;

                case 2: // Emergency details
                    const affectedPeople = document.getElementById('affected-people').value;
                    const severity = document.getElementById('emergency-severity').value;
                    const description = document.getElementById('emergency-description').value;

                    if (!affectedPeople) {
                        showNotification('Please indicate how many people are affected', 'error');
                        return false;
                    }

                    if (!severity) {
                        showNotification('Please select the emergency severity', 'error');
                        return false;
                    }

                    if (!description.trim()) {
                        showNotification('Please provide a description of the emergency', 'error');
                        return false;
                    }

                    return true;

                case 3: // Location
                    const address = document.getElementById('emergency-address').value;

                    if (!address.trim()) {
                        showNotification('Please provide the emergency location address', 'error');
                        return false;
                    }

                    return true;

                default:
                    return true;
            }
        }

        // User type selection
        document.querySelectorAll('.user-type-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.user-type-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');

                const userType = this.getAttribute('data-type');
                document.getElementById('reporter-login').classList.add('hidden');
                document.getElementById('responder-login').classList.add('hidden');
                document.getElementById('guest-login').classList.add('hidden');

                if (userType === 'reporter') {
                    document.getElementById('reporter-login').classList.remove('hidden');
                } else if (userType === 'responder') {
                    document.getElementById('responder-login').classList.remove('hidden');
                } else {
                    document.getElementById('guest-login').classList.remove('hidden');
                }
            });
        });

        // Reporter login
        document.getElementById('reporter-login-btn').addEventListener('click', function () {
            const phone = document.getElementById('reporter-phone').value;
            if (!phone) {
                showNotification('Please enter your phone number', 'error');
                return;
            }

            currentUser = {
                type: 'reporter',
                phone: phone,
                name: 'Reporter'
            };

            userDisplay.textContent = 'Reporter';
            loginModal.classList.add('hidden');
            reporterView.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            contactInfoSection.classList.remove('hidden');

            // Save session
            saveSession();

            // Clear any existing refresh interval
            if (emergencyRefreshInterval) {
                clearInterval(emergencyRefreshInterval);
                emergencyRefreshInterval = null;
            }

            // Send user info to server
            sendUserInfo();

            showNotification('Logged in as reporter', 'success');
        });

        // Responder login
        document.getElementById('responder-login-btn').addEventListener('click', function () {
            const email = document.getElementById('responder-email').value;
            const password = document.getElementById('responder-password').value;
            const organization = document.getElementById('responder-org').value;

            if (!email || !password || !organization) {
                showNotification('Please fill all fields', 'error');
                return;
            }

            // Check credentials against simulated database
            const responder = emergencyDB.responders.find(r =>
                r.email === email && r.password === password && r.organization === organization
            );

            if (responder) {
                currentUser = {
                    type: 'responder',
                    id: responder.id,
                    email: email,
                    organization: organization,
                    name: responder.name
                };

                userDisplay.textContent = responder.name;
                loginModal.classList.add('hidden');
                responderView.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');

                // Save session
                saveSession();

                // Send user info to server
                sendUserInfo();

                // Load emergencies and set up auto-refresh
                loadEmergencies();
                if (emergencyRefreshInterval) {
                    clearInterval(emergencyRefreshInterval);
                }
                emergencyRefreshInterval = setInterval(loadEmergencies, 5000); // Refresh every 5 seconds

                // Initialize analytics
                initAnalytics();

                showNotification('Logged in as responder', 'success');
            } else {
                showNotification('Invalid credentials', 'error');
            }
        });

        // Guest login
        document.getElementById('guest-login-btn').addEventListener('click', function () {
            currentUser = {
                type: 'guest',
                name: 'Guest User'
            };

            userDisplay.textContent = 'Guest';
            loginModal.classList.add('hidden');
            reporterView.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            contactInfoSection.classList.add('hidden');

            // Save session
            saveSession();

            // Clear any existing refresh interval
            if (emergencyRefreshInterval) {
                clearInterval(emergencyRefreshInterval);
                emergencyRefreshInterval = null;
            }

            // Send user info to server
            sendUserInfo();

            showNotification('Continuing as guest', 'info');
        });

        // Logout functionality
        logoutBtn.addEventListener('click', function () {
            currentUser = null;
            userDisplay.textContent = 'Guest';
            reporterView.classList.add('hidden');
            responderView.classList.add('hidden');
            loginModal.classList.remove('hidden');
            logoutBtn.classList.add('hidden');

            // Clear session
            clearSession();

            // Clear refresh interval
            if (emergencyRefreshInterval) {
                clearInterval(emergencyRefreshInterval);
                emergencyRefreshInterval = null;
            }

            showNotification('Logged out successfully', 'info');
        });

        // Submit emergency
        document.getElementById('submit-emergency').addEventListener('click', function () {
            if (!currentEmergencyType) {
                showNotification('Please select an emergency type', 'error');
                return;
            }

            const severity = document.getElementById('emergency-severity').value;
            const affectedPeople = document.getElementById('affected-people').value;
            const description = document.getElementById('emergency-description').value;
            const address = document.getElementById('emergency-address').value;
            const landmark = document.getElementById('emergency-landmark').value;

            if (!description || !address) {
                showNotification('Please provide emergency details and location', 'error');
                return;
            }

            let name = "Anonymous";
            let phone = "Not provided";
            let canContact = false;

            if (currentUser.type !== 'guest') {
                name = document.getElementById('reporter-name').value || "Anonymous";
                phone = document.getElementById('reporter-contact-phone').value || "Not provided";
                canContact = document.querySelector('input[name="contact"]:checked').value === 'yes';
            }

            // Create emergency object
            const emergency = {
                id: Date.now(),
                type: currentEmergencyType,
                severity: severity,
                affectedPeople: affectedPeople,
                description: description,
                address: address,
                landmark: landmark,
                location: userLocation || { lat: -15.3875, lng: 28.3228 },
                reporter: {
                    name: name,
                    phone: phone,
                    canContact: canContact
                },
                status: 'reported',
                timestamp: new Date(),
                responder: null,
                images: [...uploadedImages] // Store uploaded images
            };

            // Add to simulated database
            emergencyDB.emergencies.push(emergency);

            // Send to server via WebSocket
            reportEmergency(emergency);

            showNotification('Emergency reported successfully! Help is on the way.', 'success');

            // Refresh analytics if responder is logged in
            if (currentUser && currentUser.type === 'responder') {
                loadAnalyticsData();
            }

            // Reset form
            setTimeout(() => {
                // Reset form fields
                document.querySelectorAll('input[name="emergency-type"]').forEach(input => input.checked = false);
                document.getElementById('affected-people').value = '';
                document.getElementById('emergency-severity').value = '';
                document.getElementById('emergency-description').value = '';
                document.getElementById('emergency-address').value = '';
                document.getElementById('emergency-landmark').value = '';
                imagePreviewContainer.innerHTML = '';
                uploadedImages = [];

                if (currentUser.type !== 'guest') {
                    document.getElementById('reporter-name').value = '';
                    document.getElementById('reporter-contact-phone').value = '';
                }

                // Reset to first step
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                currentStep = 1;
                document.getElementById(`step-${currentStep}`).classList.add('active');
                updateStepUI();

                currentEmergencyType = null;

                showNotification('Emergency responders have been notified', 'info');
            }, 2000);
        });

        // Refresh location button
        document.getElementById('refresh-location').addEventListener('click', function () {
            initMap();
        });

        // Refresh centers button
        document.getElementById('refresh-centers').addEventListener('click', function () {
            loadRescueCenters();
        });

        // Initialize map
        function initMap() {
            if (map) {
                map.remove();
            }

            map = L.map('map').setView([-15.3875, 28.3228], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Try to get user's actual location
            if (navigator.geolocation) {
                document.getElementById('location-status').textContent = 'Detecting your location...';

                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        map.setView([userLocation.lat, userLocation.lng], 15);

                        // Add a marker for the user's location
                        if (userMarker) {
                            map.removeLayer(userMarker);
                        }

                        userMarker = L.marker([userLocation.lat, userLocation.lng]).addTo(map)
                            .bindPopup('Your location')
                            .openPopup();

                        // Add circle to show accuracy
                        L.circle([userLocation.lat, userLocation.lng], {
                            color: 'blue',
                            fillColor: '#3b82f6',
                            fillOpacity: 0.2,
                            radius: position.coords.accuracy / 2
                        }).addTo(map);

                        document.getElementById('location-status').textContent = 'Location detected';

                        // Update rescue centers based on location
                        if (currentStep === 4) {
                            loadRescueCenters();
                        }

                        // Send updated location to server
                        if (currentUser && isConnected) {
                            sendUserInfo();
                        }
                    },
                    function (error) {
                        console.error('Geolocation error:', error);
                        // Use default location (Lusaka) if geolocation fails
                        userLocation = { lat: -15.3875, lng: 28.3228 };

                        // Add a marker for the default location
                        userMarker = L.marker([userLocation.lat, userLocation.lng]).addTo(map)
                            .bindPopup('Your approximate location')
                            .openPopup();

                        document.getElementById('location-status').textContent = 'Using approximate location';

                        // Update rescue centers based on default location
                        if (currentStep === 4) {
                            loadRescueCenters();
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                // Geolocation not supported
                userLocation = { lat: -15.3875, lng: 28.3228 };

                // Add a marker for the default location
                userMarker = L.marker([userLocation.lat, userLocation.lng]).addTo(map)
                    .bindPopup('Your approximate location')
                    .openPopup();

                document.getElementById('location-status').textContent = 'Geolocation not supported';

                // Update rescue centers based on default location
                if (currentStep === 4) {
                    loadRescueCenters();
                }
            }

            // Add markers for nearby rescue centers
            emergencyDB.rescueCenters.forEach(center => {
                let iconColor;
                switch (center.type) {
                    case 'hospital': iconColor = 'red'; break;
                    case 'police': iconColor = 'blue'; break;
                    case 'fire': iconColor = 'orange'; break;
                    default: iconColor = 'gray';
                }

                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div style="background-color: ${iconColor}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                L.marker([center.location.lat, center.location.lng], { icon: icon })
                    .addTo(map)
                    .bindPopup(center.name);
            });
        }

        // Load rescue centers with proximity calculation
        function loadRescueCenters() {
            rescueCentersList.innerHTML = '';
            recommendedCenter = null;
            recommendedCenterSection.classList.add('hidden');

            if (!userLocation) {
                rescueCentersList.innerHTML = '<div class="text-center py-4 text-gray-500">Location not available. Please enable location services.</div>';
                return;
            }

            // Calculate distances and filter by emergency type if selected
            const centersWithDistances = emergencyDB.rescueCenters
                .map(center => {
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        center.location.lat, center.location.lng
                    );

                    return {
                        ...center,
                        distance: distance,
                        isRelevant: !currentEmergencyType || center.emergencyTypes.includes(currentEmergencyType)
                    };
                })
                .sort((a, b) => a.distance - b.distance);

            // Find the recommended center (closest relevant center)
            const relevantCenters = centersWithDistances.filter(center => center.isRelevant);
            if (relevantCenters.length > 0) {
                recommendedCenter = relevantCenters[0];
                displayRecommendedCenter(recommendedCenter);
            }

            // Display all centers
            if (centersWithDistances.length === 0) {
                rescueCentersList.innerHTML = '<div class="text-center py-4 text-gray-500">No rescue centers found in your area.</div>';
                return;
            }

            centersWithDistances.forEach(center => {
                const card = document.createElement('div');
                card.className = 'rescue-center-card';

                let resourcesHtml = '';
                if (center.type === 'hospital') {
                    resourcesHtml = `
                        <div class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">
                            <i class="fas fa-bed mr-1"></i> ${center.resources.bedsAvailable} beds available
                        </div>
                        <div class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                            <i class="fas fa-user-md mr-1"></i> ${center.resources.doctorsOnDuty} doctors on duty
                        </div>
                    `;
                } else if (center.type === 'police') {
                    resourcesHtml = `
                        <div class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-2">
                            <i class="fas fa-shield-alt mr-1"></i> ${center.resources.officersAvailable} officers available
                        </div>
                        <div class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                            <i class="fas fa-car mr-1"></i> ${center.resources.vehiclesAvailable} patrol vehicles
                        </div>
                    `;
                } else if (center.type === 'fire') {
                    resourcesHtml = `
                        <div class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full mr-2">
                            <i class="fas fa-fire-extinguisher mr-1"></i> ${center.resources.trucksAvailable} trucks available
                        </div>
                        <div class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                            <i class="fas fa-users mr-1"></i> ${center.resources.firefightersOnDuty} firefighters on duty
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg">${center.name}</h3>
                            <p class="text-gray-600">${center.distance.toFixed(1)} km away • Open 24 hours</p>
                            <div class="flex items-center mt-2">
                                ${resourcesHtml}
                            </div>
                            ${!center.isRelevant && currentEmergencyType ?
                        `<div class="mt-2 text-xs text-orange-600">
                                    <i class="fas fa-info-circle mr-1"></i> May not handle ${currentEmergencyType} emergencies
                                </div>` : ''
                    }
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold text-red-600">${center.phone}</div>
                            <button class="mt-2 bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm call-center" data-phone="${center.phone}">
                                <i class="fas fa-phone mr-1"></i> Call Now
                            </button>
                        </div>
                    </div>
                `;

                rescueCentersList.appendChild(card);
            });

            // Set up the call buttons
            setTimeout(setupCallButtons, 100);
        }

        // Display recommended center
        function displayRecommendedCenter(center) {
            recommendedCenterSection.classList.remove('hidden');
            recommendedName.textContent = center.name;
            recommendedDistance.textContent = `${center.distance.toFixed(1)} km away • Open 24 hours`;
            recommendedPhone.textContent = center.phone;

            let resourcesHtml = '';
            if (center.type === 'hospital') {
                resourcesHtml = `
                    <div class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">
                        <i class="fas fa-bed mr-1"></i> ${center.resources.bedsAvailable} beds available
                    </div>
                    <div class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                        <i class="fas fa-user-md mr-1"></i> ${center.resources.doctorsOnDuty} doctors on duty
                    </div>
                `;
            } else if (center.type === 'police') {
                resourcesHtml = `
                    <div class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-2">
                        <i class="fas fa-shield-alt mr-1"></i> ${center.resources.officersAvailable} officers available
                    </div>
                    <div class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                        <i class="fas fa-car mr-1"></i> ${center.resources.vehiclesAvailable} patrol vehicles
                    </div>
                `;
            } else if (center.type === 'fire') {
                resourcesHtml = `
                    <div class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full mr-2">
                        <i class="fas fa-fire-extinguisher mr-1"></i> ${center.resources.trucksAvailable} trucks available
                    </div>
                    <div class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                        <i class="fas fa-users mr-1"></i> ${center.resources.firefightersOnDuty} firefighters on duty
                    </div>
                `;
            }

            recommendedResources.innerHTML = resourcesHtml;

            // Set up the call button for the recommended center
            setTimeout(() => {
                const recommendedCallBtn = document.querySelector('#recommended-center .call-center');
                if (recommendedCallBtn) {
                    recommendedCallBtn.addEventListener('click', function () {
                        const phoneNumber = center.phone;
                        initiatePhoneCall(phoneNumber);
                    });
                }
            }, 100);
        }

        // Load emergencies for responders
        function loadEmergencies() {
            emergenciesList.innerHTML = '';

            const activeEmergencies = emergencyDB.emergencies.filter(e => e.status === 'reported' || e.status === 'dispatched');
            const respondedEmergencies = emergencyDB.emergencies.filter(e => e.status === 'responded');
            const resolvedEmergencies = emergencyDB.emergencies.filter(e => e.status === 'resolved');

            activeEmergenciesEl.textContent = activeEmergencies.length;
            respondedEmergenciesEl.textContent = respondedEmergencies.length;
            resolvedEmergenciesEl.textContent = resolvedEmergencies.length;

            if (activeEmergencies.length === 0) {
                emergenciesList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>No active emergencies at this time</p>
                    </div>
                `;
                return;
            }

            // Sort by timestamp (newest first)
            activeEmergencies.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            activeEmergencies.forEach(emergency => {
                let severityClass = 'moderate';
                if (emergency.severity.includes('Critical')) severityClass = 'critical';
                if (emergency.severity.includes('Serious')) severityClass = 'serious';

                const item = document.createElement('div');
                item.className = `emergency-item ${severityClass} p-4 bg-white rounded-lg shadow`;
                item.setAttribute('data-id', emergency.id);

                // Add new emergency indicator
                if (emergency.timestamp > Date.now() - 60000) { // Within the last minute
                    item.classList.add('new-emergency-indicator');
                }

                // Create image HTML if there are uploaded images
                let imagesHtml = '';
                if (emergency.images && emergency.images.length > 0) {
                    imagesHtml = `
                        <div class="mt-3">
                            <p class="text-sm font-medium mb-2">Uploaded Images:</p>
                            <div class="flex space-x-2 overflow-x-auto pb-2">
                                ${emergency.images.map(img => `
                                    <img src="${img}" alt="Emergency image" class="emergency-image w-32 h-24 object-cover rounded cursor-pointer" onclick="openImageModal('${img}')">
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Add dispatch info if available
                let dispatchInfo = '';
                if (emergency.status === 'dispatched') {
                    dispatchInfo = `
                        <div class="mt-2 bg-yellow-100 text-yellow-800 p-2 rounded text-sm">
                            <i class="fas fa-ambulance mr-1"></i> Unit ${emergency.dispatchedUnit} dispatched at ${formatTime(emergency.dispatchTime)}
                            ${emergency.dispatchNotes ? `<br>Notes: ${emergency.dispatchNotes}` : ''}
                        </div>
                    `;
                }

                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg">${emergency.type.toUpperCase()} Emergency</h4>
                            <p class="text-gray-600">${emergency.description}</p>
                            <div class="flex items-center mt-2">
                                <span class="priority-badge bg-${severityClass === 'critical' ? 'red' : severityClass === 'serious' ? 'yellow' : 'blue'}-100 text-${severityClass === 'critical' ? 'red' : severityClass === 'serious' ? 'yellow' : 'blue'}-800 mr-2">
                                    ${emergency.severity}
                                </span>
                                <span class="text-sm text-gray-500">${formatTime(emergency.timestamp)}</span>
                                ${emergency.timestamp > Date.now() - 60000 ? '<span class="real-time-badge">NEW</span>' : ''}
                            </div>
                            <p class="text-sm mt-2"><i class="fas fa-map-marker-alt mr-1"></i> ${emergency.address} ${emergency.landmark ? `(${emergency.landmark})` : ''}</p>
                            <p class="text-sm mt-1"><i class="fas fa-user mr-1"></i> Reported by: ${emergency.reporter.name}</p>
                            ${emergency.reporter.canContact ? `
                                <p class="text-sm mt-1"><i class="fas fa-phone mr-1"></i> Contact: ${emergency.reporter.phone}</p>
                            ` : ''}
                            ${dispatchInfo}
                            ${imagesHtml}
                        </div>
                        <div class="flex space-x-2">
                            ${emergency.reporter.canContact ? `
                                <button class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg call-reporter" data-phone="${emergency.reporter.phone}" data-name="${emergency.reporter.name}">
                                    <i class="fas fa-phone"></i>
                                </button>
                            ` : ''}
                            <button class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg respond-btn" data-id="${emergency.id}">
                                <i class="fas fa-first-aid"></i>
                            </button>
                        </div>
                    </div>
                `;

                emergenciesList.appendChild(item);

                // Add click event to select emergency
                item.addEventListener('click', function (e) {
                    // Don't trigger selection if clicking on buttons or images
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'IMG') return;

                    // Remove selection from all items
                    document.querySelectorAll('.emergency-item').forEach(el => {
                        el.classList.remove('selected');
                    });

                    // Add selection to clicked item
                    this.classList.add('selected');
                });
            });

            // Set up the call buttons
            setTimeout(setupCallButtons, 100);

            // Add event listeners for respond buttons
            document.querySelectorAll('.respond-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation(); // Prevent triggering the item click event
                    const emergencyId = parseInt(this.getAttribute('data-id'));
                    respondToEmergency(emergencyId);
                });
            });
        }

        // Open image in modal
        function openImageModal(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="close-modal">
                        <i class="fas fa-times"></i>
                    </div>
                    <img src="${imageSrc}" alt="Emergency image" class="w-full h-auto">
                </div>
            `;

            document.body.appendChild(modal);
            modal.classList.remove('hidden');

            // Close modal when clicking close button or outside
            const closeBtn = modal.querySelector('.close-modal');
            closeBtn.addEventListener('click', function () {
                document.body.removeChild(modal);
            });

            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // Respond to emergency
        function respondToEmergency(emergencyId) {
            const emergencyIndex = emergencyDB.emergencies.findIndex(e => e.id === emergencyId);
            if (emergencyIndex !== -1) {
                emergencyDB.emergencies[emergencyIndex].status = 'responded';
                emergencyDB.emergencies[emergencyIndex].responder = currentUser.name;

                // Send update to server
                updateEmergencyStatus(emergencyId, 'responded', currentUser.name);

                showNotification(`You are now responding to emergency #${emergencyId}`, 'success');
                loadEmergencies();

                // Refresh analytics
                loadAnalyticsData();

                // Simulate response process
                setTimeout(() => {
                    emergencyDB.emergencies[emergencyIndex].status = 'resolved';

                    // Send update to server
                    updateEmergencyStatus(emergencyId, 'resolved', currentUser.name);

                    showNotification(`Emergency #${emergencyId} has been resolved', 'info`);
                    loadEmergencies();
                    // Refresh analytics after resolution
                    loadAnalyticsData();
                }, 10000);
            }
        }

        // Helper function to calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            return distance;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // Format time
        function formatTime(date) {
            return new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Function to initiate phone call
        function initiatePhoneCall(phoneNumber) {
            // Clean the phone number (remove any non-digit characters except +)
            const cleanedNumber = phoneNumber.replace(/[^\d+]/g, '');
            currentCallNumber = cleanedNumber;

            // For mobile devices, this will trigger the phone dialer
            // For desktop, it won't do anything, so we'll show a message
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // Mobile device - directly initiate the call
                window.location.href = `tel:${cleanedNumber}`;
            } else {
                // Desktop device - show the number and instructions
                document.getElementById('calling-details').innerHTML = `
                    <p class="text-gray-600">Call: ${phoneNumber}</p>
                    <p class="text-sm text-gray-500 mt-2">On a mobile device, this would automatically dial the number.</p>
                `;
                document.getElementById('calling-modal').classList.remove('hidden');
            }
        }

        // Set up call buttons
        function setupCallButtons() {
            // Add event listeners to all call buttons for rescue centers
            document.querySelectorAll('.call-center').forEach(btn => {
                btn.addEventListener('click', function () {
                    const phoneNumber = this.getAttribute('data-phone');
                    initiatePhoneCall(phoneNumber);
                });
            });

            // Add event listeners to call reporter buttons for responders
            document.querySelectorAll('.call-reporter').forEach(btn => {
                btn.addEventListener('click', function () {
                    const phoneNumber = this.getAttribute('data-phone');
                    const name = this.getAttribute('data-name');
                    document.getElementById('calling-details').innerHTML = `<p class="text-gray-600">Calling: ${name} (${phoneNumber})</p>`;
                    initiatePhoneCall(phoneNumber);
                });
            });

            // Add event listener to emergency call button
            document.querySelector('.floating-action').addEventListener('click', function () {
                document.getElementById('calling-details').innerHTML = `<p class="text-gray-600">Connecting to emergency services</p>`;
                initiatePhoneCall('991');
            });
        }

        // Confirm call button
        document.getElementById('confirm-call').addEventListener('click', function () {
            if (currentCallNumber) {
                window.location.href = `tel:${currentCallNumber}`;
            }
            document.getElementById('calling-modal').classList.add('hidden');
        });

        // Cancel call button
        document.getElementById('cancel-call').addEventListener('click', function () {
            document.getElementById('calling-modal').classList.add('hidden');
            showNotification('Emergency call cancelled', 'info');
        });

        // Notification function
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'info') bgColor = 'bg-blue-500';

            notification.className = `notification ${bgColor}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Hide notification after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }

        // Simulate live status updates
        setInterval(() => {
            const statuses = ['Ready to help', 'Monitoring', 'Processing', 'Standing by'];
            const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
            document.getElementById('status').textContent = randomStatus;
        }, 8000);
    </script>
</body>

</html>