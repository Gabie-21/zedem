<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zambia Emergency Response</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#dc2626">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* Custom styles to replace missing CSS file */
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        .bg-zambia {
            background: linear-gradient(135deg, #4ca1af 0%, #c4e0e5 100%);
            min-height: 100vh;
        }

        .emergency-btn {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }

        .emergency-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .emergency-btn:active {
            transform: translateY(0);
        }

        #map {
            height: 250px;
            width: 100%;
            border-radius: 8px;
            z-index: 1;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 1rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transform: translateX(calc(100% + 20px));
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: #10b981;
        }

        .notification.error {
            background-color: #ef4444;
        }

        .notification.info {
            background-color: #3b82f6;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        .responder-card {
            background: white;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-zambia min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-red-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">üö® Emergency Response</h1>
            <div class="flex items-center space-x-2">
                <span id="status" class="text-sm">Ready</span>
                <div id="connection-indicator" class="w-3 h-3 bg-green-400 rounded-full"></div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 max-w-md flex-grow">
        <!-- Location Status -->
        <div id="location-status" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center justify-between">
                <span class="text-blue-800 font-semibold">üìç Current Location</span>
                <button id="refresh-location" class="text-blue-600 hover:text-blue-800 transition-colors duration-200">
                    üîÑ Refresh
                </button>
            </div>
            <p id="location-text" class="text-sm text-gray-600 mt-1">Getting your location...</p>
        </div>

        <!-- Emergency Buttons -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button class="emergency-btn" data-type="medical" data-priority="P1">
                <div class="text-4xl mb-2">üè•</div>
                <div class="text-lg font-semibold">MEDICAL</div>
                <div class="text-xs opacity-80">Life threatening</div>
            </button>

            <button class="emergency-btn" data-type="fire" data-priority="P1">
                <div class="text-4xl mb-2">üî•</div>
                <div class="text-lg font-semibold">FIRE</div>
                <div class="text-xs opacity-80">Fire emergency</div>
            </button>

            <button class="emergency-btn" data-type="police" data-priority="P2">
                <div class="text-4xl mb-2">üëÆ</div>
                <div class="text-lg font-semibold">POLICE</div>
                <div class="text-xs opacity-80">Crime/Security</div>
            </button>

            <button class="emergency-btn" data-type="general" data-priority="P3">
                <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                <div class="text-lg font-semibold">OTHER</div>
                <div class="text-xs opacity-80">General help</div>
            </button>
        </div>

        <!-- Quick Actions -->
        <div class="space-y-3 mb-6">
            <button id="call-emergency"
                class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-green-300 relative overflow-hidden">
                üìû Call Emergency Services
            </button>
            <button id="find-help"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300 relative overflow-hidden">
                üîç Find Nearby Help
            </button>
        </div>

        <!-- Map Container (Hidden by default) -->
        <div id="map-container" class="hidden mb-6">
            <h3 class="font-semibold mb-2 text-white">üìç Emergency Location</h3>
            <div id="map" class="h-64 rounded-lg border border-gray-300 shadow-lg"></div>
        </div>

        <!-- Active Emergency Display -->
        <div id="active-emergency" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg shadow-lg">
            <h3 class="font-bold text-red-800 mb-2">üö® Emergency Active</h3>
            <div id="emergency-details"></div>
            <div class="mt-4 space-y-2">
                <button id="cancel-emergency"
                    class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-gray-300">
                    Cancel Emergency
                </button>
            </div>
        </div>

        <!-- Responder Simulation -->
        <div id="responder-section" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg shadow-lg">
            <h3 class="font-bold text-green-800 mb-3">üë®‚Äç‚öïÔ∏è Community Responders</h3>
            <div id="responder-list" class="space-y-2">
                <!-- Responders will be populated here -->
            </div>
        </div>
    </main>

    <!-- Emergency Modal -->
    <div id="emergency-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-2xl border border-gray-200">
            <h2 class="text-xl font-bold text-red-600 mb-4">üö® Confirm Emergency</h2>
            <div id="modal-content"></div>
            <div class="flex space-x-3 mt-6">
                <button id="confirm-emergency"
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded font-semibold transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-red-300">
                    CONFIRM
                </button>
                <button id="cancel-modal"
                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded font-semibold transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-gray-800 via-gray-900 to-black text-white mt-12 py-8">
        <div class="container mx-auto px-4 max-w-md text-center">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-red-400 mb-2">üáøüá≤ Zambia Emergency Response</h3>
                <p class="text-sm text-gray-300">Connecting communities in times of need</p>
            </div>

            <div class="border-t border-gray-700 pt-4 mt-4">
                <p class="text-xs text-gray-400 mb-2">
                    ¬© 2025 Zambia Emergency Response System. All rights reserved.
                </p>
                <p class="text-xs text-gray-500">
                    Developed by <span class="text-red-400 font-semibold">Edina Gabriella Ngalasa</span>
                </p>
            </div>

            <div class="mt-4 text-xs text-gray-500">
                <p>For emergencies, always call local emergency services first</p>
            </div>
        </div>
    </footer>

    <!-- Firebase Configuration -->
    <script type="module">
        // Firebase configuration for Zambia Emergency Response System
        const firebaseConfig = {
            apiKey: "AIzaSyATFnJ_nufdoN4QAcYLjXsZd-eANz988h8",
            authDomain: "zambia-emergency-response.firebaseapp.com",
            projectId: "zambia-emergency-response",
            storageBucket: "zambia-emergency-response.firebasestorage.app",
            messagingSenderId: "745207632001",
            appId: "1:745207632001:web:11754eaed394e960708b80",
            measurementId: "G-BLS7RYQKVB"
        };

        // Collection names for consistency
        const COLLECTIONS = {
            EMERGENCIES: 'emergencies',
            RESPONDERS: 'responders',
            USERS: 'users',
            MESSAGES: 'emergency_messages',
            NOTIFICATIONS: 'notifications',
            EMERGENCY_CONTACTS: 'emergency_contacts',
            LOCATIONS: 'emergency_locations'
        };

        // Emergency types with additional metadata
        const EMERGENCY_TYPES = {
            MEDICAL: {
                id: 'medical',
                name: 'Medical Emergency',
                priority: 'P1',
                icon: 'üè•',
                color: '#dc2626',
                description: 'Life-threatening medical situation requiring immediate response',
                requiredResponders: ['medical', 'first_aid', 'paramedic']
            },
            FIRE: {
                id: 'fire',
                name: 'Fire Emergency',
                priority: 'P1',
                icon: 'üî•',
                color: '#ea580c',
                description: 'Fire or dangerous situation requiring immediate fire service response',
                requiredResponders: ['fire', 'rescue']
            },
            POLICE: {
                id: 'police',
                name: 'Police Required',
                priority: 'P2',
                icon: 'üëÆ',
                color: '#2563eb',
                description: 'Security incident or crime requiring police response',
                requiredResponders: ['police', 'security']
            },
            GENERAL: {
                id: 'general',
                name: 'General Emergency',
                priority: 'P3',
                icon: '‚ö†Ô∏è',
                color: '#ca8a04',
                description: 'Other emergency situations requiring assistance',
                requiredResponders: ['general', 'community']
            }
        };

        // Emergency priorities with response times
        const EMERGENCY_PRIORITIES = {
            P1: {
                name: 'CRITICAL',
                description: 'Life-threatening emergency',
                targetResponseTime: 5, // minutes
                color: '#dc2626',
                notificationSound: 'critical',
                autoDispatch: true
            },
            P2: {
                name: 'URGENT',
                description: 'Urgent response needed',
                targetResponseTime: 10,
                color: '#ea580c',
                notificationSound: 'urgent',
                autoDispatch: true
            },
            P3: {
                name: 'IMPORTANT',
                description: 'Important but not critical',
                targetResponseTime: 20,
                color: '#ca8a04',
                notificationSound: 'normal',
                autoDispatch: false
            }
        };

        // Zambia-specific emergency contacts
        const ZAMBIA_EMERGENCY_CONTACTS = {
            NATIONAL: {
                EMERGENCY_SERVICES: '911',
                POLICE: '999',
                FIRE_BRIGADE: '993',
                AMBULANCE: '992',
                DISASTER_MANAGEMENT: '991'
            },
            LUSAKA: {
                UTH_EMERGENCY: '+260211256067',
                LUSAKA_CENTRAL_POLICE: '+260211228794',
                FIRE_STATION: '+260211228844',
                DISASTER_MANAGEMENT: '+260211254509'
            },
            COPPERBELT: {
                KITWE_CENTRAL_HOSPITAL: '+260212221355',
                NDOLA_CENTRAL_HOSPITAL: '+260212612100',
                COPPERBELT_POLICE: '+260212210025'
            },
            SOUTHERN: {
                LIVINGSTONE_HOSPITAL: '+260213320946',
                CHOMA_HOSPITAL: '+260213220251'
            }
        };

        // Import Firebase SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);

        // Global state
        let currentLocation = null;
        let activeEmergency = null;
        let map = null;
        let responders = [];
        let currentUser = null;
        let isOnline = navigator.onLine;

        // Real Firebase functions
        const FirebaseAPI = {
            // Initialize user authentication
            async initializeAuth() {
                return new Promise((resolve, reject) => {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUser = user;
                            console.log('User authenticated:', user.uid);
                            resolve(user);
                        } else {
                            // Sign in anonymously
                            signInAnonymously(auth)
                                .then((result) => {
                                    currentUser = result.user;
                                    console.log('Anonymous user created:', currentUser.uid);
                                    resolve(currentUser);
                                })
                                .catch((error) => {
                                    console.error('Authentication failed:', error);
                                    reject(error);
                                });
                        }
                    });
                });
            },

            // Create emergency in Firestore
            async createEmergency(emergencyData) {
                try {
                    const docRef = await addDoc(collection(db, COLLECTIONS.EMERGENCIES), {
                        ...emergencyData,
                        userId: currentUser.uid,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        status: 'active',
                        responders: [],
                        messages: []
                    });

                    const emergency = {
                        ...emergencyData,
                        id: docRef.id,
                        userId: currentUser.uid,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        status: 'active',
                        responders: [],
                        messages: []
                    };

                    console.log('Emergency created in Firebase:', emergency.id);
                    return emergency;
                } catch (error) {
                    console.error('Error creating emergency:', error);
                    throw error;
                }
            },

            // Listen to nearby responders (simulated for demo)
            async listenToNearbyResponders(location, radiusKm, callback) {
                // In production, this would query Firestore for nearby responders
                setTimeout(() => {
                    const mockResponders = [
                        {
                            id: 'resp1',
                            name: 'Dr. Sarah Mwamba',
                            type: 'Medical',
                            location: { lat: location.lat + 0.01, lng: location.lng + 0.01 },
                            distance: 0.8,
                            eta: 3,
                            status: 'available',
                            phone: '+260977123456',
                            specialization: 'Emergency Medicine'
                        },
                        {
                            id: 'resp2',
                            name: 'James Banda',
                            type: 'First Aid',
                            location: { lat: location.lat - 0.01, lng: location.lng + 0.01 },
                            distance: 1.2,
                            eta: 5,
                            status: 'available',
                            phone: '+260966789012',
                            specialization: 'Community First Aid'
                        },
                        {
                            id: 'resp3',
                            name: 'Fire Station Central',
                            type: 'Fire',
                            location: { lat: location.lat + 0.02, lng: location.lng - 0.01 },
                            distance: 2.1,
                            eta: 8,
                            status: 'available',
                            phone: '+260955123789',
                            specialization: 'Fire & Rescue'
                        }
                    ];
                    callback(mockResponders);
                }, 1000);
            },

            // Update emergency status
            async updateEmergencyStatus(emergencyId, status, additionalData = {}) {
                try {
                    const emergencyRef = doc(db, COLLECTIONS.EMERGENCIES, emergencyId);
                    await updateDoc(emergencyRef, {
                        status,
                        updatedAt: serverTimestamp(),
                        ...additionalData
                    });
                    console.log('Emergency status updated:', { emergencyId, status });
                    return { success: true };
                } catch (error) {
                    console.error('Error updating emergency:', error);
                    throw error;
                }
            },

            // Add message to emergency
            async addEmergencyMessage(emergencyId, message, senderType = 'user') {
                try {
                    const messageData = {
                        emergencyId,
                        senderId: currentUser.uid,
                        senderType,
                        message,
                        timestamp: serverTimestamp(),
                        read: false
                    };

                    const docRef = await addDoc(collection(db, COLLECTIONS.MESSAGES), messageData);

                    console.log('Message sent:', docRef.id);
                    return { ...messageData, id: docRef.id };
                } catch (error) {
                    console.error('Error sending message:', error);
                    throw error;
                }
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                await initializeAppWithFirebase();
                setupEventListeners();
                requestLocation();
                setupNetworkMonitoring();
                showNotification('System initialized successfully', 'success');
            } catch (error) {
                console.error('App initialization failed:', error);
                showNotification('Failed to initialize. Running in offline mode.', 'error');
                initializeOfflineMode();
            }
        });

        async function initializeAppWithFirebase() {
            updateStatus('Connecting to Firebase...');

            try {
                // Initialize Firebase authentication
                await FirebaseAPI.initializeAuth();
                updateStatus('Connected');
                document.getElementById('connection-indicator').className = 'w-3 h-3 bg-green-400 rounded-full';

                // Set up real-time listeners
                setupRealTimeListeners();

            } catch (error) {
                console.error('Firebase initialization error:', error);
                throw error;
            }
        }

        function initializeOfflineMode() {
            updateStatus('Offline Mode');
            document.getElementById('connection-indicator').className = 'w-3 h-3 bg-yellow-400 rounded-full';
            setupEventListeners();
            requestLocation();
        }

        function setupRealTimeListeners() {
            // Listen for emergency updates if there's an active emergency
            if (activeEmergency && activeEmergency.id) {
                const unsubscribe = onSnapshot(doc(db, COLLECTIONS.EMERGENCIES, activeEmergency.id), (doc) => {
                    if (doc.exists()) {
                        const updatedEmergency = { id: doc.id, ...doc.data() };
                        console.log('Emergency updated:', updatedEmergency);
                        activeEmergency = updatedEmergency;
                        updateEmergencyDisplay();
                    }
                });
            }
        }

        function setupEventListeners() {
            // Emergency buttons
            document.querySelectorAll('.emergency-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const type = this.dataset.type;
                    const priority = this.dataset.priority;
                    showEmergencyModal(type, priority);
                });
            });

            // Modal buttons
            document.getElementById('confirm-emergency').addEventListener('click', confirmEmergency);
            document.getElementById('cancel-modal').addEventListener('click', hideEmergencyModal);
            document.getElementById('cancel-emergency').addEventListener('click', cancelEmergency);

            // Location refresh
            document.getElementById('refresh-location').addEventListener('click', requestLocation);

            // Quick actions
            document.getElementById('call-emergency').addEventListener('click', function () {
                const emergencyNumbers = {
                    'Zambia': {
                        'Police': '911',
                        'Fire': '993',
                        'Medical': '992',
                        'General Emergency': '991'
                    }
                };

                let numbersText = 'Zambia Emergency Numbers:\n';
                Object.entries(emergencyNumbers['Zambia']).forEach(([service, number]) => {
                    numbersText += `${service}: ${number}\n`;
                });

                alert(numbersText);
            });

            document.getElementById('find-help').addEventListener('click', showNearbyHelp);
        }

        function setupNetworkMonitoring() {
            window.addEventListener('online', function () {
                isOnline = true;
                updateStatus('Back Online');
                document.getElementById('connection-indicator').className = 'w-3 h-3 bg-green-400 rounded-full';
                showNotification('Connection restored', 'success');

                // Attempt to reconnect to Firebase
                if (!currentUser) {
                    initializeAppWithFirebase().catch(console.error);
                }
            });

            window.addEventListener('offline', function () {
                isOnline = false;
                updateStatus('Offline');
                document.getElementById('connection-indicator').className = 'w-3 h-3 bg-red-400 rounded-full';
                showNotification('You are now offline', 'info');
            });
        }

        async function confirmEmergency() {
            const modal = document.getElementById('emergency-modal');
            const type = modal.dataset.type;
            const priority = modal.dataset.priority;

            if (!currentLocation) {
                showNotification('Location is required for emergency reporting. Please enable location services.', 'error');
                return;
            }

            updateStatus('Creating emergency...');

            try {
                const emergencyData = {
                    type: type,
                    priority: priority,
                    location: currentLocation,
                    timestamp: new Date(),
                    description: '',
                    mediaUrls: [],
                    contactPhone: '',
                    status: 'active'
                };

                if (isOnline && currentUser) {
                    // Create emergency in Firebase
                    activeEmergency = await FirebaseAPI.createEmergency(emergencyData);
                } else {
                    // Create emergency locally for offline mode
                    activeEmergency = {
                        ...emergencyData,
                        id: 'local-' + Date.now(),
                        userId: 'offline-user',
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        responders: [],
                        messages: [],
                        isOffline: true
                    };

                    // Store for later sync when online
                    storeOfflineEmergency(activeEmergency);
                }

                hideEmergencyModal();
                showActiveEmergency();

                // Start looking for responders
                await dispatchToResponders();

                updateStatus('Emergency active');
                showNotification('Emergency reported successfully', 'success');

            } catch (error) {
                console.error('Error confirming emergency:', error);
                showNotification('Failed to create emergency. Please try again.', 'error');
                updateStatus('Error occurred');
            }
        }

        async function dispatchToResponders() {
            if (!currentLocation || !activeEmergency) return;

            updateStatus('Finding responders...');

            try {
                // Listen for nearby responders
                await FirebaseAPI.listenToNearbyResponders(
                    currentLocation,
                    10, // 10km radius
                    (responders) => {
                        updateResponderDisplay(responders);

                        // Simulate responder notifications
                        responders.slice(0, 3).forEach((responder, index) => {
                            setTimeout(() => {
                                simulateResponderResponse(responder);
                            }, (index + 1) * 2000);
                        });
                    }
                );

                updateStatus('Responders notified');

            } catch (error) {
                console.error('Error dispatching to responders:', error);
                updateStatus('Dispatch error');
            }
        }

        function updateResponderDisplay(respondersData) {
            responders = respondersData;
            const responderSection = document.getElementById('responder-section');
            const responderList = document.getElementById('responder-list');

            if (responders.length === 0) {
                responderList.innerHTML = '<div class="text-center text-gray-500 py-4">No responders available nearby</div>';
                responderSection.classList.remove('hidden');
                return;
            }

            // Filter responders based on emergency type
            let relevantResponders = responders.filter(r => {
                if (activeEmergency.type === 'medical') return r.type === 'Medical' || r.type === 'First Aid';
                if (activeEmergency.type === 'fire') return r.type === 'Fire' || r.type === 'First Aid';
                if (activeEmergency.type === 'police') return r.type === 'Police';
                return true;
            });

            responderList.innerHTML = relevantResponders.map(responder => `
                <div class="responder-card flex justify-between items-center p-3 bg-white rounded border" data-responder-id="${responder.id}">
                    <div>
                        <div class="font-semibold">${responder.name}</div>
                        <div class="text-sm text-gray-600">${responder.specialization || responder.type}</div>
                        <div class="text-xs text-gray-500">${responder.distance.toFixed(1)}km away</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-blue-600">ETA: ${responder.eta} min</div>
                        <div class="text-xs responder-status text-gray-500">Notifying...</div>
                    </div>
                </div>
            `).join('');

            responderSection.classList.remove('hidden');
        }

        function simulateResponderResponse(responder) {
            const responderCard = document.querySelector(`[data-responder-id="${responder.id}"]`);
            if (!responderCard) return;

            const statusElement = responderCard.querySelector('.responder-status');

            const responses = ['Accepted', 'En route', 'Declined', 'No response'];
            const weights = [0.7, 0.0, 0.2, 0.1];

            const random = Math.random();
            let response;
            if (random < weights[0]) response = 'Accepted';
            else if (random < weights[0] + weights[1]) response = 'En route';
            else if (random < weights[0] + weights[1] + weights[2]) response = 'Declined';
            else response = 'No response';

            if (response === 'Accepted') {
                statusElement.innerHTML = '<span class="text-green-600 font-semibold">‚úì Accepted</span>';
                responderCard.classList.add('ring-2', 'ring-green-300');

                setTimeout(() => {
                    statusElement.innerHTML = '<span class="text-blue-600 font-semibold">üöó En route</span>';
                }, 1000);

                setTimeout(() => {
                    statusElement.innerHTML = '<span class="text-purple-600 font-semibold">üìç Arrived</span>';
                    updateStatus('Responder arrived');
                    showNotification(`${responder.name} has arrived at your location`, 'success');
                }, responder.eta * 60 * 1000);

            } else if (response === 'Declined') {
                statusElement.innerHTML = '<span class="text-red-600">‚úó Declined</span>';
                responderCard.classList.add('opacity-50');
            } else {
                statusElement.innerHTML = '<span class="text-gray-400">No response</span>';
                responderCard.classList.add('opacity-30');
            }
        }

        function showActiveEmergency() {
            const container = document.getElementById('active-emergency');
            const details = document.getElementById('emergency-details');

            const emergencyTypes = {
                medical: 'üè• Medical Emergency',
                fire: 'üî• Fire Emergency',
                police: 'üëÆ Police Required',
                general: '‚ö†Ô∏è General Emergency'
            };

            details.innerHTML = `
                <div class="space-y-2">
                    <div><strong>Type:</strong> ${emergencyTypes[activeEmergency.type]}</div>
                    <div><strong>Priority:</strong> <span class="text-red-600 font-bold">${activeEmergency.priority}</span></div>
                    <div><strong>ID:</strong> <code class="text-xs bg-gray-100 px-1 rounded">${activeEmergency.id}</code></div>
                    <div><strong>Time:</strong> ${activeEmergency.timestamp ? new Date(activeEmergency.timestamp).toLocaleTimeString() : 'Unknown'}</div>
                    <div><strong>Status:</strong> <span class="text-red-600 font-semibold">üî¥ ACTIVE</span></div>
                    ${activeEmergency.isOffline ? '<div class="text-yellow-600 text-sm">‚ö†Ô∏è Created offline - will sync when online</div>' : ''}
                    <div id="responder-count" class="text-sm text-gray-600">Searching for responders...</div>
                </div>
                
                <!-- Chat Interface -->
                <div class="mt-4 p-3 bg-gray-50 rounded">
                    <h4 class="font-semibold text-sm mb-2">üí¨ Emergency Chat</h4>
                    <div id="chat-messages" class="space-y-1 max-h-32 overflow-y-auto text-sm">
                        <div class="text-gray-500">Emergency created. Help is on the way...</div>
                    </div>
                    <div class="flex mt-2">
                        <input type="text" id="chat-input" placeholder="Send message..." 
                               class="flex-1 text-xs p-2 border rounded-l focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="send-message" class="bg-blue-600 text-white px-3 py-2 rounded-r text-xs">Send</button>
                    </div>
                </div>
            `;

            container.classList.remove('hidden');
            showMapWithLocation();
            setupEmergencyChat();
        }

        function setupEmergencyChat() {
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-message');
            const chatMessages = document.getElementById('chat-messages');

            if (!chatInput || !sendButton || !chatMessages) return;

            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                // Add message to chat
                const messageDiv = document.createElement('div');
                messageDiv.className = 'text-blue-600 text-right';
                messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
                chatMessages.appendChild(messageDiv);

                chatInput.value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Send to Firebase if online
                if (isOnline && currentUser) {
                    FirebaseAPI.addEmergencyMessage(activeEmergency.id, message, 'user')
                        .catch(error => console.error('Failed to send message:', error));
                }

                // Simulate responder reply
                setTimeout(() => {
                    const replyDiv = document.createElement('div');
                    replyDiv.className = 'text-green-600';
                    replyDiv.innerHTML = `<strong>Responder:</strong> Message received. On my way!`;
                    chatMessages.appendChild(replyDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 2000);
            }

            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') sendMessage();
            });
        }

        async function cancelEmergency() {
            if (!activeEmergency) return;

            try {
                if (isOnline && !activeEmergency.isOffline) {
                    await FirebaseAPI.updateEmergencyStatus(activeEmergency.id, 'cancelled');
                } else {
                    // Handle offline cancellation
                    removeOfflineEmergency(activeEmergency.id);
                }

                activeEmergency = null;
                document.getElementById('active-emergency').classList.add('hidden');
                document.getElementById('responder-section').classList.add('hidden');
                document.getElementById('map-container').classList.add('hidden');

                updateStatus('Emergency cancelled');
                showNotification('Emergency cancelled successfully', 'success');

                if (map) {
                    map.remove();
                    map = null;
                }

            } catch (error) {
                console.error('Error cancelling emergency:', error);
                showNotification('Failed to cancel emergency. Please try again.', 'error');
            }
        }

        function showMapWithLocation() {
            if (!currentLocation) return;

            const mapContainer = document.getElementById('map-container');
            mapContainer.classList.remove('hidden');

            if (map) {
                map.remove();
            }

            map = L.map('map').setView([currentLocation.lat, currentLocation.lng], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            const emergencyMarker = L.marker([currentLocation.lat, currentLocation.lng])
                .addTo(map)
                .bindPopup(`üö® Emergency Location<br>ID: ${activeEmergency ? activeEmergency.id : 'Unknown'}`)
                .openPopup();

            L.circle([currentLocation.lat, currentLocation.lng], {
                radius: currentLocation.accuracy || 100,
                color: 'red',
                fillColor: '#ff0000',
                fillOpacity: 0.1
            }).addTo(map);

            if (responders.length > 0) {
                responders.forEach(responder => {
                    if (responder.location) {
                        L.marker([responder.location.lat, responder.location.lng])
                            .addTo(map)
                            .bindPopup(`üë®‚Äç‚öïÔ∏è ${responder.name}<br>${responder.specialization}<br>ETA: ${responder.eta} min`);

                        L.polyline([
                            [responder.location.lat, responder.location.lng],
                            [currentLocation.lat, currentLocation.lng]
                        ], { color: 'blue', weight: 2, opacity: 0.7 }).addTo(map);
                    }
                });
            }
        }

        function requestLocation() {
            updateLocationStatus('Getting your location...');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date()
                        };

                        const accuracyText = currentLocation.accuracy < 100 ?
                            `Located (¬±${Math.round(currentLocation.accuracy)}m)` :
                            `Located (¬±${Math.round(currentLocation.accuracy / 1000 * 10) / 10}km)`;

                        updateLocationStatus(accuracyText);
                        showNotification('Location acquired successfully', 'success');

                        if (activeEmergency && isOnline) {
                            updateEmergencyLocation();
                        }
                    },
                    error => {
                        console.error('Location error:', error);
                        handleLocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 300000
                    }
                );
            } else {
                updateLocationStatus('Location not supported');
                currentLocation = {
                    lat: -15.3875,
                    lng: 28.3228,
                    accuracy: 10000,
                    timestamp: new Date(),
                    isDefault: true
                };
                showNotification('Using default location (Lusaka)', 'info');
            }
        }

        function handleLocationError(error) {
            let errorMessage = 'Location unavailable';

            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Location access denied. Please enable location services.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Location information unavailable.';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'Location request timed out.';
                    break;
            }

            updateLocationStatus(errorMessage);
            showNotification(errorMessage, 'error');

            currentLocation = {
                lat: -15.3875,
                lng: 28.3228,
                accuracy: 10000,
                timestamp: new Date(),
                isDefault: true
            };

            setTimeout(() => {
                updateLocationStatus('Using default location (Lusaka)');
            }, 3000);
        }

        async function updateEmergencyLocation() {
            if (!activeEmergency || !currentLocation || activeEmergency.isOffline) return;

            try {
                await FirebaseAPI.updateEmergencyStatus(activeEmergency.id, 'active', {
                    location: currentLocation,
                    locationUpdatedAt: new Date()
                });

                console.log('Emergency location updated');
            } catch (error) {
                console.error('Error updating emergency location:', error);
            }
        }

        function showNearbyHelp() {
            if (!currentLocation) {
                showNotification('Location is required to show nearby help. Please enable location services.', 'error');
                return;
            }

            showMapWithNearbyServices();
        }

        function showMapWithNearbyServices() {
            const mapContainer = document.getElementById('map-container');
            mapContainer.classList.remove('hidden');

            if (map) {
                map.remove();
            }

            map = L.map('map').setView([currentLocation.lat, currentLocation.lng], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            L.marker([currentLocation.lat, currentLocation.lng])
                .addTo(map)
                .bindPopup('üìç Your Location')
                .openPopup();

            const nearbyServices = [
                {
                    name: 'University Teaching Hospital',
                    type: 'hospital',
                    lat: -15.3955,
                    lng: 28.3200,
                    phone: '+260211256067',
                    icon: 'üè•'
                },
                {
                    name: 'Lusaka Central Police',
                    type: 'police',
                    lat: -15.4167,
                    lng: 28.2833,
                    phone: '+260211228794',
                    icon: 'üëÆ'
                },
                {
                    name: 'Lusaka Fire Station',
                    type: 'fire',
                    lat: -15.4100,
                    lng: 28.2900,
                    phone: '+260211228844',
                    icon: 'üî•'
                },
                {
                    name: 'Levy Mwanawasa Hospital',
                    type: 'hospital',
                    lat: -15.3700,
                    lng: 28.3500,
                    phone: '+260211256700',
                    icon: 'üè•'
                }
            ];

            nearbyServices.forEach(service => {
                L.marker([service.lat, service.lng])
                    .addTo(map)
                    .bindPopup(`
                        ${service.icon} <strong>${service.name}</strong><br>
                        Type: ${service.type}<br>
                        Phone: ${service.phone}
                    `);
            });

            const group = new L.featureGroup([
                L.marker([currentLocation.lat, currentLocation.lng]),
                ...nearbyServices.map(s => L.marker([s.lat, s.lng]))
            ]);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        // Offline data management
        function storeOfflineEmergency(emergency) {
            try {
                const offlineEmergencies = JSON.parse(localStorage.getItem('offlineEmergencies') || '[]');
                offlineEmergencies.push(emergency);
                localStorage.setItem('offlineEmergencies', JSON.stringify(offlineEmergencies));

                // Register for sync when online
                if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                    navigator.serviceWorker.ready.then(registration => {
                        return registration.sync.register('emergency-sync');
                    });
                }
            } catch (error) {
                console.error('Failed to store offline emergency:', error);
            }
        }

        function removeOfflineEmergency(emergencyId) {
            try {
                const offlineEmergencies = JSON.parse(localStorage.getItem('offlineEmergencies') || '[]');
                const filtered = offlineEmergencies.filter(e => e.id !== emergencyId);
                localStorage.setItem('offlineEmergencies', JSON.stringify(filtered));
            } catch (error) {
                console.error('Failed to remove offline emergency:', error);
            }
        }

        function updateEmergencyDisplay() {
            if (activeEmergency) {
                showActiveEmergency();
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            // Remove existing notification
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Hide notification after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }

        // Utility functions
        function updateLocationStatus(text) {
            const locationText = document.getElementById('location-text');
            if (locationText) {
                locationText.textContent = text;
            }
        }

        function updateStatus(text) {
            const status = document.getElementById('status');
            if (status) {
                status.textContent = text;
            }
        }

        function showEmergencyModal(type, priority) {
            const modal = document.getElementById('emergency-modal');
            const content = document.getElementById('modal-content');

            const emergencyTypes = {
                medical: { emoji: 'üè•', name: 'Medical Emergency', desc: 'Medical assistance needed immediately' },
                fire: { emoji: 'üî•', name: 'Fire Emergency', desc: 'Fire or dangerous situation requiring immediate response' },
                police: { emoji: 'üëÆ', name: 'Police Required', desc: 'Security incident or crime in progress' },
                general: { emoji: '‚ö†Ô∏è', name: 'General Emergency', desc: 'Other emergency requiring assistance' }
            };

            const emergency = emergencyTypes[type];
            const priorityInfo = {
                P1: { name: 'CRITICAL', color: 'text-red-600', desc: 'Life-threatening emergency' },
                P2: { name: 'URGENT', color: 'text-orange-600', desc: 'Urgent response needed' },
                P3: { name: 'IMPORTANT', color: 'text-yellow-600', desc: 'Important but not critical' }
            };

            const priorityData = priorityInfo[priority] || priorityInfo.P3;

            content.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-3">${emergency.emoji}</div>
                    <h3 class="text-lg font-semibold mb-2">${emergency.name}</h3>
                    <div class="mb-3">
                        <span class="px-2 py-1 rounded text-sm font-bold ${priorityData.color} bg-gray-100">
                            ${priorityData.name}
                        </span>
                    </div>
                    <p class="text-gray-600 mb-4">${emergency.desc}</p>
                    <div class="bg-gray-100 p-3 rounded text-sm text-left">
                        <strong>Location Status:</strong><br>
                        ${currentLocation ?
                    `‚úÖ Located (¬±${Math.round(currentLocation.accuracy || 100)}m accuracy)` :
                    '‚ùå Location not available'
                }<br><br>
                        <strong>Connection Status:</strong><br>
                        ${isOnline ? '‚úÖ Online - Full functionality available' : '‚ö†Ô∏è Offline - Limited functionality'}<br><br>
                        <strong>What happens next:</strong><br>
                        ‚Ä¢ ${isOnline ? 'Nearby responders will be notified' : 'Emergency will be stored and synced when online'}<br>
                        ‚Ä¢ Emergency services contact information will be provided<br>
                        ‚Ä¢ You'll receive real-time updates<br>
                        ‚Ä¢ Help typically arrives within 5-15 minutes
                    </div>
                </div>
            `;

            modal.dataset.type = type;
            modal.dataset.priority = priority;

            modal.classList.remove('hidden');
        }

        function hideEmergencyModal() {
            document.getElementById('emergency-modal').classList.add('hidden');
        }

        // Push notification setup
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                    return true;
                } else {
                    console.log('Notification permission denied');
                }
            }
            return false;
        }

        // Initialize notification permission on app load
        requestNotificationPermission().catch(console.error);

        // Handle emergency shortcuts from PWA
        function handleEmergencyShortcut() {
            const urlParams = new URLSearchParams(window.location.search);
            const emergency = urlParams.get('emergency');
            const action = urlParams.get('action');

            if (emergency) {
                setTimeout(() => {
                    const priority = emergency === 'medical' || emergency === 'fire' ? 'P1' : 'P2';
                    showEmergencyModal(emergency, priority);
                }, 1000);
            }

            if (action === 'find-help') {
                setTimeout(() => {
                    showNearbyHelp();
                }, 1000);
            }
        }

        // Call shortcut handler after page load
        window.addEventListener('load', handleEmergencyShortcut);

        // Export functions for testing or external use
        window.EmergencyApp = {
            requestLocation,
            showNearbyHelp,
            confirmEmergency,
            cancelEmergency,
            showNotification
        };
    </script>
</body>

</html>